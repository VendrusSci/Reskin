!function(){function t(t,i){this.time=i.duration||1.5,this.actor=zi(t[1]),this.message=new le(i.getMessage(this.actor)),this.update=function(t){this.time-=t,this.message.update(t),this.time<0&&Ia.room.actionQueue.endAction()},this.draw=function(t){vi()}}function i(i){t.call(this,i,{getMessage:function(t){return t.name+" defends."}})}function e(t,i){t.prototype=Object.create(i.prototype)}function a(t){this.actor=t.actor,this.startPos=t.startPos,this.endPos=t.endPos,this.peakJumpHeight=.4*this.startPos.distanceTo(this.endPos),di.call(this,{duration:t.duration,update:function(t){if(this.actor.snapTo($i(this.startPos,this.endPos,t)),this.actor.floating)this.actor.additionalElevation=0;else{var i=4*t-4*t*t;this.actor.additionalElevation=i*this.peakJumpHeight}}})}function n(t){this.actor=t.actor,this.startPos=t.startPos,this.endPos=t.endPos,di.call(this,{duration:t.duration,update:function(t){this.actor.snapTo($i(this.startPos,this.endPos,t))}})}function s(t){this.args=t,this.spritz=null,this.state="init"}function r(t){var i=t.ability,e=i.target,s=t.duration,r=i.targetUndodgedPos,o=i.targetDodgedPos,h=s-.15-.25;return 0>h&&(h=0),new ri([new a({actor:e,startPos:r,endPos:o,duration:.15}),new di({duration:h}),new n({actor:e,startPos:o,endPos:r,duration:.25})])}function o(t){var i,e=t.actor,a=e.position;return i=e.playerControlled?e.position.add(-16,0):e.position.add(16,0),new ri([new n({actor:e,startPos:a,endPos:i,duration:.05}),new n({actor:e,startPos:i,endPos:a,duration:.05})])}function h(t){var i=this;this.abilityId=t[0],this.actor=zi(t[1]),this.target=zi(t[2]),this.guardedActor=null,null!==t[6]&&(this.guardedActor=zi(t[6])),null!==t[7]&&(this.guardedByActor=zi(t[7])),this.guarded=null!==this.guardedActor&&null!==this.guardedByActor,this.reflectedByActor=null,null!==t[8]&&(this.reflectedByActor=zi(t[8])),this.reflected=null!==this.reflectedByActor,this.damage=t[3],this.hitType=t[4],this.clash=t[5],this.messageText=t[9],this.message=null,this.firedDodge=!1,this.firedKnockback=!1,this.firedSpritz=!1,this.anims=new hi,this.screenShaking=0,this.simpleCasterPos=this.actor.origin,this.simpleCasterCenter=this.actor.origin.add(.5*this.actor.sprite.frameWidth,.5*this.actor.sprite.height),this.simpleTargetPos=this.target.origin,this.simpleTargetCenter=this.target.origin.add(.5*this.target.sprite.frameWidth,.5*this.target.sprite.height),this.guarded?(this.guarderStartPos=this.guardedByActor.position,this.guardedActor.playerControlled?this.guarderGuardPos=this.guardedActor.position.add(+this.guardedActor.sprite.frameWidth,0):this.guarderGuardPos=this.guardedActor.position.add(-this.guardedActor.sprite.frameWidth,0),this.guarderEndPos=this.guarderStartPos):(this.guarderStartPos=ne(0,0),this.guarderGuardPos=ne(0,0),this.guarderEndPos=ne(0,0)),this.targetStartPos=this.target.position,this.guarded&&this.guardedByActor==this.target?this.targetUndodgedPos=this.guarderGuardPos:this.targetUndodgedPos=this.target.position,this.target.playerControlled?this.targetDodgedPos=this.targetUndodgedPos.add(-this.target.sprite.frameWidth,0):this.targetDodgedPos=this.targetUndodgedPos.add(+this.target.sprite.frameWidth,0),this.guarded&&this.guardedByActor==this.target&&(this.targetDodgedPos=this.targetDodgedPos.add(0,25)),this.targetEndPos=this.target.origin,this.casterStartPos=this.actor.position,this.target.playerControlled?this.casterMeleePos=this.targetUndodgedPos.add(+this.target.sprite.frameWidth,0):this.casterMeleePos=this.targetUndodgedPos.add(-this.target.sprite.frameWidth,0),this.casterEndPos=this.actor.origin,this.fireDodge=function(t){void 0===t&&(t=.5),this.hitType!==la.DODGE&&this.hitType!==la.MISS||this.firedDodge||(this.anims.add(r({ability:this,duration:t})),this.firedDodge=!0)},this.fireKnockback=function(){this.damage>0&&!this.firedKnockback&&(this.anims.add(o({actor:this.target})),this.firedKnockback=!0)},this.fireSpritz=function(){this.firedSpritz||(this.anims.add(new s({amount:this.damage,target:this.target,hitType:this.hitType,clash:this.clash})),this.firedSpritz=!0)},this.beforeDraws=[],this.afterDraws=[],this.afterDrawAlls=[],this.addBeforeDrawActor=function(t){this.beforeDraws.push(t)},this.addAfterDrawActor=function(t){this.afterDraws.push(t)},this.addAfterDrawAllActors=function(t){this.afterDrawAlls.push(t)},this.messageText&&this.anims.add(new ri([new li(function(){i.message=new le(i.messageText)}),new di({duration:1.5}),new li(function(){i.message=null})])),this._allAnims=this.anims,this.simpleGuardAlpha=0,this.guarded?Ia.options.animations?this._allAnims=new ri([new a({actor:this.guardedByActor,startPos:this.guarderStartPos,endPos:this.guarderGuardPos,duration:.3}),this.anims,new a({actor:this.guardedByActor,startPos:this.guarderGuardPos,endPos:this.guarderEndPos,duration:.3})]):(this._allAnims=new ri([new di({duration:.3,update:function(t){i.simpleGuardAlpha=t}}),this.anims,new di({duration:.3,update:function(t){i.simpleGuardAlpha=1-t}})]),this.addAfterDrawActor(function(t){if(t==i.guardedActor&&i.simpleGuardAlpha>0){var e=qt(ha.GUARD,{frames:3}),a=i.guardedActor.position.add(.5*i.guardedActor.sprite.frameWidth,.5*i.guardedActor.sprite.height);Si(e,{pos:a,xOrigin:.5,yOrigin:.5,frame:2,alpha:i.simpleGuardAlpha})}})):this._allAnims=this.anims;(new Date).getTime();this.update=function(t){if(this.message&&this.message.update(t),this._allAnims.update(t),this._allAnims.isDone()){(new Date).getTime();Ia.room.actionQueue.endAction()}},this.draw=function(t){vi({beforeActor:function(t){for(var e in i.beforeDraws){var a=i.beforeDraws[e];a(t)}},afterActor:function(t){for(var e in i.afterDraws){var a=i.afterDraws[e];a(t)}},afterAllActors:function(){for(var t in i.afterDrawAlls){var e=i.afterDrawAlls[t];e()}}})}}function l(t){return t.playerControlled?t.position.add(t.sprite.frameWidth,0):t.position.add(-t.sprite.frameWidth,0)}function c(t,i){h.call(this,t),this.sprite=xi(Je+t[0]+".png"),this.yOffset=void 0!==i.yOffset?i.yOffset:0,this.slashReveal=0,this.slashAlpha=0,this.slashShake=ne(0,0);var e=this;this.anims.add(new ri([new ci(function(){return e.sprite.loaded}),new oi(function(){return e.actor!=e.target},[new a({duration:.28,actor:this.actor,startPos:this.casterStartPos,endPos:this.casterMeleePos})]),new li(function(){e.fireDodge()}),new di({duration:.14,update:function(t){t>.5&&e.fireKnockback(),e.slashAlpha=1,e.slashReveal=t}}),new di({duration:.05,update:function(t){e.slashAlpha=1,e.slashReveal=1}}),new di({duration:.1,update:function(t){e.slashAlpha=1-t,e.slashReveal=1}}),new li(function(){e.fireSpritz()})])),this.addAfterDrawActor(function(t){if(t===e.target&&e.slashAlpha>0){var i=e.sprite;e.target.playerControlled&&(i=Pi(i));var a=[-2,-1,0,1,2],n=.5*e.target.sprite.frameWidth-.5*e.sprite.frameWidth,s=.5*e.target.sprite.height-.5*e.sprite.height;n+=Wi(a),s+=Wi(a),Si(i,{pos:e.targetUndodgedPos.add(n,s+e.yOffset),percentVert:e.slashReveal,alpha:e.slashAlpha})}})}function d(t){c.call(this,t,{})}function p(t){var i=t.ability,e=t.actor,a=t.sprite1,n=t.sprite2,s=t.frame1,r=t.frame2,o=1;void 0!==t.alpha&&(o=t.alpha);var h=t.duration||1,l=0,c=0,d=0,p=0,u=t.xOffset||0,f=t.yOffset||0,m=t.fixedPosition;return i.addAfterDrawActor(function(t){if(t===e){var i=e.position;m&&(i=m);var h=e.sprite.frameWidth/2-a.frameWidth/2;Si(a,{pos:i.add(u+h,d+f),frame:s,alpha:l*o}),Si(n,{pos:i.add(u+h,p+f),frame:r,alpha:c*o})}}),new di({duration:h,update:function(t){l=.2>t?qi(t,0,.2,0,1):qi(t,.2,.8,1,0),c=Gi(2*l,0,1),d=Vi(16,-16,t),p=2*d}})}function u(t,i){h.call(this,t);var e=Je+t[0]+".png",a=xi(e,{frames:2}),n=this,s=1.05,r=1.05,o=1;void 0!==i.alpha&&(o=i.alpha),this.anims.add(p({actor:this.target,duration:1,sprite1:a,sprite2:a,frame1:0,frame2:1,ability:this,alpha:o})),this.anims.add(new ri([new di({duration:.33,update:function(t){Ia.options.animations&&(n.actor.scale=ne(Vi(1,s,t),1))}}),new di({duration:.165,update:function(t){Ia.options.animations&&(n.actor.scale=ne(Vi(s,1,t),Vi(1,r,t)))}}),new di({duration:.165,update:function(t){Ia.options.animations&&(n.actor.scale=ne(1,Vi(r,1,t)))}}),new li(function(){n.actor.scale=ne(1,1)})]))}function f(t){u.call(this,t,{})}function m(t){c.call(this,t,{})}function g(t){c.call(this,t,{yOffset:-25})}function w(t){var i=t.ability;return new di({duration:.2,update:function(t){i.reflectedByActor.bubbles[_a.REFLECT].alpha=Vi(1,ka.baseBubbleAlpha,t)}})}function v(t){function i(){return ne(.5*a.sprite.frameWidth,20+.5*d.height)}var e=t.ability,a=t.actor,n=void 0!==t.doReflectAnim?t.doReflectAnim:!0,s=t.duration||.7,r=0,o=.05,h=.88,l=1,c=0,d=xi("/content/battle/images/abilities/strip8_casting.png"),p=t.blue?4:0;e.addBeforeDrawActor(function(t){t===a&&Si(d,{pos:a.position.add(i()),alpha:c,frame:p+2*r+0,xScale:h,yScale:l,xOrigin:.5,yOrigin:.5})}),e.addAfterDrawActor(function(t){t===a&&Si(d,{pos:a.position.add(i()),alpha:c,frame:p+2*r+1,xScale:h,yScale:l,xOrigin:.5,yOrigin:.5})});var u=[new ci(function(){return d.loaded}),new hi([new di({duration:s,update:function(t){c=t}}),new di({duration:s,update:function(t){var i=t*s,e=Math.floor(i/o);r=e%2}})]),new li(function(){c=0})];return n&&e.reflected&&u.push(w({ability:e})),new ri(u)}function b(t,i){h.call(this,t),this.sprite=xi(Je+t[0]+".png");var e=this,a=this.casterStartPos.add(.5*this.actor.sprite.frameWidth,.5*this.actor.sprite.height),n=a;this.reflected&&(n=this.guarded&&this.reflectedByActor==this.guardedByActor?this.guarderGuardPos.add(.5*this.reflectedByActor.sprite.frameWidth,.5*this.reflectedByActor.sprite.height):this.reflectedByActor.position.add(.5*this.reflectedByActor.sprite.frameWidth,.5*this.reflectedByActor.sprite.height));var s=this.targetUndodgedPos.add(.5*this.target.sprite.frameWidth,.5*this.target.sprite.height);if(0===this.damage){var r=s.sub(n);s=n.add(r.mul(2.25))}var o,l,c=n.sub(a),d=s.sub(n),p=a,u=0,f=0,m=999;o=this.reflected?.4:0,0===this.damage?(l=o+.9,m=l-.1):l=o+.4;var g=.1,b=o+.25,y=0,A=!1;this.anims.add(new ri([new ci(function(){return e.sprite.loaded}),v({actor:this.actor,duration:.7,ability:this,doReflectAnim:!1}),new hi([new ri([new di({duration:l,update:function(t){var i=l*t;u=1,g>=i?u=qi(i,0,g,0,1):i>=m&&(u=qi(i,m,l,1,0));var e,r;o>i?(r=c,e=qi(i,f,o,0,1),p=$i(a,n,e)):(r=d,e=qi(i,o,l,0,1),p=$i(n,s,e)),y=Math.atan2(r.y,r.x),r.x<0?(A=!0,y+=Math.PI):A=!1}}),new li(function(){u=0,e.fireKnockback(),e.fireSpritz()})]),new ri([new di({duration:b}),new li(function(){e.fireDodge()})]),new ri([new di({duration:o}),new li(function(){e.reflected&&e.anims.add(w({ability:e}))})])])])),this.addAfterDrawAllActors(function(){if(u>0){var t=e.sprite;A&&(t=Pi(t)),Si(t,{pos:p,rotation:y,alpha:u,xOrigin:.5,yOrigin:.5})}})}function y(t){b.call(this,t,{})}function A(t){b.call(this,t,{})}function x(t){b.call(this,t,{})}function S(t){b.call(this,t,{})}function _(t){b.call(this,t,{})}function C(t){b.call(this,t,{})}function k(t){b.call(this,t,{})}function E(t){b.call(this,t,{})}function O(t){b.call(this,t,{})}function T(t){b.call(this,t,{})}function B(t){b.call(this,t,{})}function D(t){c.call(this,t,{})}function P(t){c.call(this,t,{})}function I(t){c.call(this,t,{})}function N(t){c.call(this,t,{})}function M(t){c.call(this,t,{})}function F(t){c.call(this,t,{})}function R(t){c.call(this,t,{})}function L(t){c.call(this,t,{})}function j(t){c.call(this,t,{})}function W(t){c.call(this,t,{})}function z(t){c.call(this,t,{})}function Y(t){var i=t.ability,e=t.actor,a=xi("/content/battle/images/abilities/strip2_orangearrows.png",{frames:2});return arrowVisible=!1,arrowT=0,i.addAfterDrawActor(function(t){if(t===e&&arrowVisible){var i=ne(e.sprite.frameWidth,e.sprite.height),n=ne(a.frameWidth,a.height),s=e.position.add(i.mul(.5)).sub(n.mul(.5)),r=s.add(ne(0,-40-30*arrowT)),o=s.add(ne(0,-40-60*arrowT)),h=0,l=0;h=arrowT<.4?qi(arrowT,.2,.4,0,1):qi(arrowT,.4,1,1,0),l=arrowT<.2?qi(arrowT,0,.2,0,1):qi(arrowT,.2,.8,1,0),Si(a,{pos:r,alpha:h,frame:0}),Si(a,{pos:o,alpha:l,frame:1})}}),new ri([new ci(function(){return a.loaded}),new di({duration:t.duration||1,update:function(t){arrowT=t,arrowVisible=!0}}),new li(function(){arrowVisible=!1})])}function H(t){h.call(this,t);var i=10;this.sprite=xi(Je+t[0]+".png",{frames:i}),this.pocketwatchAlpha=0,this.pocketwatchFrame=0;var e=1.7,a=this;this.anims.add(new ri([new ci(function(){return a.sprite.loaded}),v({actor:this.actor,duration:.7,ability:this,blue:!0}),new hi([new ri([new di({duration:e-1}),Y({ability:this,actor:this.target,duration:1})]),new ri([new di({duration:.1,update:function(t){a.pocketwatchAlpha=t}}),new di({duration:e-.2,update:function(t){a.pocketwatchAlpha=1}}),new di({duration:.1,update:function(t){a.pocketwatchAlpha=1-t}})]),new di({duration:e,update:function(t){var e=2*t*t+.5*t;a.pocketwatchFrame=Math.floor(26*e)%i}})]),new li(function(){a.pocketwatchAlpha=0,a.arrowVisible=!1})])),this.addAfterDrawAllActors(function(){if(a.pocketwatchAlpha>0){var t=a.sprite,i=ne(a.target.sprite.frameWidth,a.target.sprite.height),e=ne(a.sprite.frameWidth,a.sprite.height);Si(t,{pos:a.target.position.add(i.mul(.5)).sub(e.mul(.5)),alpha:a.pocketwatchAlpha,frame:a.pocketwatchFrame})}})}function U(t,i){h.call(this,t),this.sprite=xi(Je+t[0]+".png",{frames:4}),this.circleAlpha=0,this.beamAlpha=1,this.beamReveal=0;var e=this;this.anims.add(new ri([v({actor:this.actor,duration:.7,ability:this,blue:i.blueChanneling}),new li(function(){e.fireDodge(1.7)}),new hi([new ri([new di({duration:.25,update:function(t){e.circleAlpha=t}}),new di({duration:1.2,update:function(t){e.circleAlpha=1}}),new di({duration:.25,update:function(t){e.circleAlpha=1-t}})]),new ri([new di({duration:.25}),new di({duration:.25,update:function(t){e.beamReveal=t}}),new di({duration:.9}),new li(function(){e.fireKnockback(),e.fireSpritz()})]),new ri([new di({duration:1.2,update:function(t){e.beamAlpha=1}}),new di({duration:.25,update:function(t){e.beamAlpha=1-t}}),new di({duration:.25,update:function(t){e.beamAlpha=0}})]),new ri([new di({duration:.7}),p({actor:this.target,fixedPosition:this.targetUndodgedPos,duration:1,sprite1:this.sprite,sprite2:this.sprite,frame1:2,frame2:3,ability:this,yOffset:-35})])])])),this.addBeforeDrawActor(function(t){if(t==e.target&&e.circleAlpha>0){var i=e.targetUndodgedPos.x+.5*e.target.sprite.frameWidth-.5*e.sprite.frameWidth;Si(e.sprite,{pos:ne(i,e.targetUndodgedPos.y),alpha:e.circleAlpha,frame:0})}}),this.addAfterDrawActor(function(t){if(t==e.target&&e.beamAlpha>0){var i=e.targetUndodgedPos.x+.5*e.target.sprite.frameWidth-.5*e.sprite.frameWidth;Si(e.sprite,{pos:ne(i,e.targetUndodgedPos.y),alpha:e.beamAlpha,frame:1,percentVert:e.beamReveal,percentVertReverse:!0})}})}function G(t){U.call(this,t,{blueChanneling:!0})}function V(t,i){h.call(this,t);var e=this.target.bubbles[i.bubbleType],a=0,n=1,s=1.4;this.anims.add(new ri([new ci(function(){return e.sprite.loaded}),v({actor:this.actor,duration:.7,ability:this,blue:!0}),new di({duration:.3,update:function(t){e.scale=Vi(a,s,t),e.alpha=1}}),new di({duration:.1,update:function(t){e.scale=Vi(s,n,t),e.alpha=1}}),new di({duration:.9,update:function(t){e.alpha=Vi(1,ka.baseBubbleAlpha,t),e.scale=n}})]))}function q(t){V.call(this,t,{bubbleType:_a.REFLECT})}function X(t){V.call(this,t,{bubbleType:_a.BOLSTER})}function K(t){V.call(this,t,{bubbleType:_a.WARD})}function Q(t){h.call(this,t),this.sprite=xi(Je+t[0]+".png",{frames:2}),this.craterAlpha=0,this.beamAlpha=1,this.beamReveal=0;var i=this;this.anims.add(new ri([v({actor:this.actor,duration:.7,ability:this,blue:!0}),new hi([new ri([new di({duration:.25,update:function(t){i.craterAlpha=t}}),new di({duration:1.2,update:function(t){i.craterAlpha=1}}),new di({duration:.25,update:function(t){i.craterAlpha=1-t}})]),new ri([new di({duration:.25,update:function(t){i.screenShaking=t}}),new di({duration:.25,update:function(t){i.screenShaking=Vi(1,.5,t)}}),new di({duration:.7,update:function(t){i.screenShaking=.5}}),new di({duration:.5,update:function(t){i.screenShaking=Vi(.5,0,t)}})]),new ri([new di({duration:.25}),new di({duration:.25,update:function(t){i.beamReveal=t}}),new di({duration:1.2})]),new ri([new di({duration:1.45,update:function(t){i.beamAlpha=1}}),new di({duration:.25,update:function(t){i.beamAlpha=1-t}})]),new ri([new di({duration:.375}),Y({ability:this,actor:this.target,duration:1})])])]));var e=-30;this.addBeforeDrawActor(function(t){if(t==i.target&&i.craterAlpha>0){var a=i.target.position.x+.5*i.target.sprite.frameWidth-.5*i.sprite.frameWidth;Si(i.sprite,{pos:ne(a,i.target.position.y+e),alpha:i.craterAlpha,frame:0})}}),this.addAfterDrawActor(function(t){if(t==i.target&&i.beamAlpha>0){var a=i.target.position.x+.5*i.target.sprite.frameWidth-.5*i.sprite.frameWidth;Si(i.sprite,{pos:ne(a,i.target.position.y+e),alpha:i.beamAlpha,frame:1,percentVert:i.beamReveal,percentVertReverse:!0})}})}function Z(t,i){h.call(this,t),this.sprite=xi(Je+t[0]+".png",{frames:3});this.anims.add(new ri([v({actor:this.actor,duration:.7,ability:this,blue:!0}),p({actor:this.target,duration:1.2,sprite1:this.sprite,sprite2:this.sprite,frame1:1,frame2:2,ability:this,yOffset:-20})]))}function J(t){Z.call(this,t,{})}function tt(t,i){h.call(this,t),this.sprite=xi(Je+t[0]+".png",{frames:4}),this.potionY=0,this.potionAlpha=0;var e=this;this.anims.add(new ri([new hi([new ri([new di({duration:.25,update:function(t){e.potionAlpha=t}}),new di({duration:.5,update:function(t){e.potionAlpha=1}}),new di({duration:.25,update:function(t){e.potionAlpha=1-t}})]),new ri([new di({duration:.7,update:function(t){e.potionY=-30*ie(t)}})]),new ri([new di({duration:.75}),bt({sprite:this.sprite,baseFrame:1,actor:this.target,ability:this}),new li(function(){e.fireSpritz()})])])])),this.addAfterDrawActor(function(t){if(t==e.actor&&e.potionAlpha>0){var i=e.actor.position.x+.5*e.actor.sprite.frameWidth-.5*e.sprite.frameWidth,a=e.actor.position.y+.5*e.actor.sprite.height-.5*e.sprite.height;Si(e.sprite,{pos:ne(i,a+e.potionY),alpha:e.potionAlpha,frame:0})}})}function it(t){tt.call(this,t,{})}function et(t){var i=t.actor,e=t.ability,a=t.sprite,n=0,s=0,r=0,o=0,h=0,l=0,c=!1;return e.addAfterDrawActor(function(t){if(t===i&&c){var e=i.position.add(ne(.5*i.sprite.frameWidth,.5*i.sprite.height)),d=140,p=Vi(1,2,r);Si(a,{pos:e.add(ne(Vi(-d,0,n),0)),frame:0,alpha:o,xOrigin:.5,yOrigin:.5}),Si(a,{pos:e.add(ne(Vi(+d,0,s),0)),frame:1,alpha:h,xOrigin:.5,yOrigin:.5}),Si(a,{pos:e,frame:2,xScale:p,yScale:p,alpha:l,xOrigin:.5,yOrigin:.5})}}),new ri([new li(function(){c=!0}),new di({duration:.2,update:function(t){o=qi(t,0,.25,0,1),n=t}}),new di({duration:.2,update:function(t){h=qi(t,0,.25,0,1),s=t}}),new di({duration:.4,update:function(t){l=1-t,r=t}}),new di({duration:.1,update:function(t){l=0}}),new di({duration:.3,update:function(t){o=h=1-t}}),new li(function(){c=!1})])}function at(t,i){h.call(this,t);var e=xi(Je+t[0]+".png",{frames:3});this.anims.add(new ri([et({actor:this.target,ability:this,sprite:e})]))}function nt(t){at.call(this,t,{})}function st(t){b.call(this,t,{})}function rt(t){U.call(this,t,{blueChanneling:!1})}function ot(i){t.call(this,i,{getMessage:function(t){return t.name+" flutters in the breeze..."}})}function ht(t){h.call(this,t),this.sprite=xi("/content/battle/images/abilities/strip2_shroudA.png"),this.particles=[],this.particles.push({rightToLeft:!1,startT:0,endT:1,y:.2}),this.particles.push({rightToLeft:!1,startT:.2,y:.6}),this.particles.push({rightToLeft:!1,startT:.4,y:1}),this.particles.push({rightToLeft:!0,startT:.5,y:0}),this.particles.push({rightToLeft:!0,startT:.3,y:.4}),this.particles.push({rightToLeft:!0,startT:.1,y:.8});var i=!1,e=0,a=this,n=1.7;this.anims.add(new ri([new ci(function(){return a.sprite.loaded}),v({actor:this.actor,duration:.7,ability:this}),new li(function(){i=!0,a.fireDodge(n)}),new di({duration:n,update:function(t){e=t*n}}),new li(function(){i=!1,a.fireSpritz(),a.fireKnockback()})])),this.addAfterDrawActor(function(t){if(t==a.target&&i)for(var n in a.particles){var s=a.particles[n],r=e-s.startT;r=Gi(r/1.2,0,1);var o=Pi(a.sprite),h=a.targetUndodgedPos.x+.5*a.target.sprite.frameWidth-.5*a.sprite.frameWidth,l=a.targetUndodgedPos.y+.5*a.target.sprite.height-.5*a.sprite.height,c=.5*Vi(-100,100,r)-25;s.rightToLeft&&(c*=-1);var d=1;.25>r?d=qi(r,0,.25,0,1):r>.75&&(d=qi(r,.75,1,1,0)),Si(s.rightToLeft?o:a.sprite,{pos:ne(h+c,l+Vi(-15,15,s.y)-10),alpha:d,frame:s.rightToLeft?1:0})}})}function lt(t){function i(t,i){if(t===e.target&&s>0){var n=0,r=1,o=e.sprite;e.target.playerControlled&&(o=Pi(o),n=1,r=0);var h=.5*e.target.sprite.frameWidth,l=e.target.sprite.height,c=.5*a;i?(Si(o,{pos:e.targetUndodgedPos.add(h-20,l-20),alpha:s,frame:r,xScale:1+.05*Xi(c+.7,7),yScale:1+.15*(Xi(c+.5,7)-.5),xOrigin:.5,yOrigin:.85}),Si(o,{pos:e.targetUndodgedPos.add(h+20,l-20),alpha:s,frame:r,xScale:1+.05*Xi(c+.3,9),yScale:1+.15*(Xi(c+.6,5)-.5),xOrigin:.5,yOrigin:.85})):Si(o,{pos:e.targetUndodgedPos.add(h,l),alpha:s,frame:n,xScale:1+.05*Xi(c,8),yScale:1+.15*(Xi(c,6)-.5),xOrigin:.5,yOrigin:.85})}}h.call(this,t),this.sprite=xi(Je+t[0]+".png",{frames:2});var e=this,a=0,n=.9,s=0;this.anims.add(new ri([new ci(function(){return e.sprite.loaded}),v({actor:this.actor,duration:.7,ability:this}),new hi([new ri([new li(function(){e.fireDodge(n)}),new di({duration:n,update:function(t){a=t*n}}),new li(function(){e.fireSpritz(),e.fireKnockback()})]),new ri([new di({duration:.1,update:function(t){s=t}}),new di({duration:n-.2,update:function(t){s=1}}),new di({duration:.1,update:function(t){s=1-t}})])])])),this.addBeforeDrawActor(function(t){i(t,!0)}),this.addAfterDrawActor(function(t){i(t,!1)})}function ct(t){h.call(this,t),this.sprite=xi(Je+t[0]+".png",{frames:3});var i=this,e=0,a=0,n=1.7,s=0,r=0;this.anims.add(new ri([new ci(function(){return i.sprite.loaded}),v({actor:this.actor,duration:.7,ability:this}),new li(function(){i.fireDodge(n)}),new hi([new ri([new di({duration:.5}),new li(function(){a=0,i.fireSpritz(),i.fireKnockback()})]),new ri([new di({duration:.2,update:function(t){e=t,a=1,i.screenShaking=1}}),new di({duration:1,update:function(t){e=1,a=1,i.screenShaking=qi(t,0,.33,1,0)}}),new di({duration:.3,update:function(t){e=1,a=1-t,i.screenShaking=0}}),new di({duration:.2,update:function(t){e=0,a=0}})]),new ri([new di({duration:.25*n,update:function(t){s=t}}),new di({duration:.5*n,update:function(t){s=1}}),new di({duration:.25*n,update:function(t){s=1-t}})]),new di({duration:n,update:function(t){r=t}})])])),this.addAfterDrawActor(function(t){if(t==i.target){var n=i.targetUndodgedPos.x+.5*i.target.sprite.frameWidth-.5*i.sprite.frameWidth,o=i.targetUndodgedPos.y+.5*i.target.sprite.height-.5*i.sprite.height;if(a>0&&e>0&&Si(i.sprite,{pos:ne(n,o+(1-e)*i.sprite.height),percentVert:e,alpha:a,frame:0}),s>0){var h=Vi(-50,50,r)-25;Si(i.sprite,{pos:ne(n+h,o),alpha:s,frame:1}),Si(i.sprite,{pos:ne(n-h,o),alpha:s,frame:2})}}})}function dt(t){h.call(this,t),this.sprite=xi(Je+t[0]+".png",{frames:3});var i=this,e=0,a=0,n=1.7,s=0;this.anims.add(new ri([new ci(function(){return i.sprite.loaded}),v({actor:this.actor,duration:.7,ability:this}),new li(function(){i.fireDodge(n)}),new hi([new ri([new di({duration:.6,update:function(t){s=t}})]),new ri([new di({duration:.2,update:function(t){e=t,a=1,i.screenShaking=1}}),new di({duration:1.2,update:function(t){e=1,a=1,i.screenShaking=1-t}}),new di({duration:.3,update:function(t){a=1-t}})])]),new li(function(){i.fireSpritz(),i.fireKnockback()})])),this.addAfterDrawActor(function(t){if(t==i.target){var n=i.targetUndodgedPos.x+.5*i.target.sprite.frameWidth-.5*i.sprite.frameWidth,r=i.targetUndodgedPos.y+.5*i.target.sprite.height-.5*i.sprite.height;if(a>0&&e>0&&Si(i.sprite,{pos:ne(n,r+(1-e)*i.sprite.height),percentVert:e,alpha:a,frame:0}),s>0&&1>s){var o=1;.2>s?o=qi(s,0,.2,0,1):s>.75&&(o=qi(s,.75,1,1,0));var h=100*s,l=-100*(4*s-4*s*s)+50;Si(i.sprite,{pos:ne(n+h,r+l),alpha:o,frame:1}),Si(i.sprite,{pos:ne(n-h,r+l),alpha:o,frame:2})}}})}function pt(t){h.call(this,t),this.sprite=xi(Je+t[0]+".png",{frames:2});var i=this,e=0,a=0,n=1.7;this.anims.add(new ri([new ci(function(){return i.sprite.loaded}),v({actor:this.actor,duration:.7,ability:this}),new li(function(){i.fireDodge(n)}),new hi([new di({duration:1,update:function(t){e=t}}),new ri([new di({duration:1.4,update:function(t){a=1}}),new di({duration:.3,update:function(t){a=1-t}})])]),new li(function(){i.fireSpritz(),i.fireKnockback()})])),this.addAfterDrawActor(function(t){if(t==i.target){var n=i.targetUndodgedPos.x+.5*i.target.sprite.frameWidth,s=i.targetUndodgedPos.y+.5*i.target.sprite.height;if(a>0&&e>0){var r=Vi(.66,1,e);Si(i.sprite,{pos:ne(n,s),percentVert:e,percentVertReverse:!0,alpha:a,frame:1,xScale:r,yScale:r,xOrigin:.5,yOrigin:.5})}}})}function ut(t){h.call(this,t),this.sprite=xi(Je+t[0]+".png",{frames:5});var i=this,e=0,a=0,n=1.3,s=0,r=0;this.anims.add(new ri([new ci(function(){return i.sprite.loaded}),v({actor:this.actor,duration:.7,ability:this}),new li(function(){i.fireDodge(n)}),new hi([new ri([new di({duration:1.3,update:function(t){r=Math.floor(5*t),r=Gi(r,0,3)}})]),new ri([new di({duration:.3,update:function(t){s=t}}),new di({duration:.7,update:function(t){s=1}}),new di({duration:.3,update:function(t){s=1-t}})]),new ri([new di({duration:.3,update:function(t){e=t,a=1}}),new di({duration:.7,update:function(t){e=1,a=1}}),new di({duration:.3,update:function(t){e=1,a=1-t}})])]),new li(function(){i.fireSpritz(),i.fireKnockback()})])),this.addAfterDrawActor(function(t){function n(t){return i.target.playerControlled?4-t:t}if(t==i.target){var o=i.targetUndodgedPos.x+.5*i.target.sprite.frameWidth-.5*i.sprite.frameWidth,h=i.targetUndodgedPos.y+.5*i.target.sprite.height-.5*i.sprite.height;if(a>0&&e>0||s>0){var l=i.sprite,c=l;if(i.target.playerControlled&&(c=Pi(l)),Si(c,{pos:ne(o,h-60),percentVert:e,alpha:a,frame:n(0)}),i.damage>0){var d=20;Si(l,{pos:ne(o+d,h-60),alpha:s,frame:1+r})}}}})}function ft(t){h.call(this,t),this.sprite=xi(Je+t[0]+".png",{frames:3});var i=this,e=0,a=0,n=.2,s=.4,r=.1,o=.3,l=.5,c=0,d=0,p=Math.max(n,s)+r+o+l;this.screenShaking=0,this.anims.add(new ri([new ci(function(){return i.sprite.loaded}),v({actor:this.actor,duration:.7,ability:this}),new li(function(){i.fireDodge(p)}),new hi([new ri([new di({duration:.1,update:function(t){e=t,a=1}}),new di({duration:.3}),new di({duration:.5,update:function(t){a=1-t}})]),new ri([new di({duration:n}),new di({duration:r,update:function(t){c=t,i.screenShaking=1}}),new di({duration:o,update:function(t){c=1,i.screenShaking=1}}),new di({duration:l,update:function(t){c=1-t,i.screenShaking=1-t}})]),new ri([new di({duration:s}),new di({duration:r,update:function(t){d=t}}),new di({duration:o,update:function(t){d=1}}),new di({duration:l,update:function(t){d=1-t}})])]),new li(function(){i.fireSpritz(),i.fireKnockback()})])),this.addAfterDrawActor(function(t){if(t==i.target){var n=i.targetUndodgedPos.x+.5*i.target.sprite.frameWidth,s=i.targetUndodgedPos.y+.5*i.target.sprite.height;e>0&&a>0&&Si(i.sprite,{pos:ne(n,s),percentVert:e,alpha:a,frame:0,xOrigin:.5,yOrigin:.5}),c>0&&(Si(i.sprite,{pos:ne(n-30,s-15),alpha:c,frame:2,xOrigin:.5,yOrigin:.5}),Si(i.sprite,{pos:ne(n+30,s-15),alpha:c,frame:2,xOrigin:.5,yOrigin:.5})),d>0&&Si(i.sprite,{pos:ne(n,s),alpha:d,frame:1,xOrigin:.5,yOrigin:.5})}})}function mt(t){h.call(this,t),this.sprite=xi(Je+t[0]+".png",{frames:3}),this.cloudSprite=xi("/content/battle/images/abilities/strip2_plgCloudsGrn.png");var i=this,e=0,a=0,n=0,s=0,r=1.5;this.anims.add(new ri([new ci(function(){return i.sprite.loaded&&i.cloudSprite.loaded}),v({actor:this.actor,duration:.7,ability:this}),new li(function(){i.fireDodge(r)}),new hi([new ri([new di({duration:.33,update:function(t){a=t}}),new di({duration:.66,update:function(t){a=1}}),new di({duration:.33,update:function(t){a=1-t}})]),new ri([new di({duration:1.33,update:function(t){e=t}})]),new ri([new di({duration:1.2,update:function(t){n=t}})]),new ri([new di({duration:1.5,update:function(t){s=t}})])]),new li(function(){i.fireSpritz(),i.fireKnockback()})])),this.addBeforeDrawActor(function(t){if(t==i.target){var n=i.targetUndodgedPos.x+.5*i.target.sprite.frameWidth,s=i.targetUndodgedPos.y+.5*i.target.sprite.height;if(a>0){var r=Vi(.66,1.5,e);Si(i.sprite,{pos:ne(n,s+43),alpha:a,xScale:r,yScale:r,xOrigin:.5,yOrigin:.8})}}}),this.addAfterDrawActor(function(t){if(t==i.target){var e=i.targetUndodgedPos.x+.5*i.target.sprite.frameWidth,a=i.targetUndodgedPos.y+.5*i.target.sprite.height,r=1;if(.5>n?r=qi(n,0,.5,0,1):n>.5&&(r=qi(n,.5,1,1,0)),r>0){var o=Vi(.9,1.1,n),h=Vi(10,-60,n);Si(i.sprite,{pos:ne(e,a+h),alpha:Gi(1.5*r,0,1),frame:1,xOrigin:.5,yOrigin:.5,xScale:o,yScale:o}),Si(i.sprite,{pos:ne(e,a+1.33*h),alpha:r,frame:2,xOrigin:.5,yOrigin:.5,xScale:o,yScale:o})}var l=1;if(.25>s?l=qi(s,0,.25,0,1):s>.75&&(l=qi(s,.75,1,1,0)),s>0){var c=Vi(-50,50,s)-10,d=-20;Si(i.cloudSprite,{pos:ne(e+c,a+d),alpha:l,frame:0,xOrigin:.5,yOrigin:.5}),Si(i.cloudSprite,{pos:ne(e-c,a+d),alpha:l,frame:1,xOrigin:.5,yOrigin:.5})}}})}function gt(t){h.call(this,t),this.sprite=xi(Je+t[0]+".png",{frames:3});var i=this,e=0,a=!1,n=0;this.anims.add(new ri([new ci(function(){return i.sprite.loaded}),v({actor:this.actor,duration:.7,ability:this}),new li(function(){i.fireDodge()}),new hi([new ri([new di({duration:.34,update:function(t){a=!0,e=t}})]),new ri([new di({duration:.4,update:function(t){n=t}})])]),new li(function(){a=!1,i.fireSpritz(),i.fireKnockback()})])),this.addAfterDrawActor(function(t){if(t==i.target){var s=i.targetUndodgedPos.x+.5*i.target.sprite.frameWidth,r=i.targetUndodgedPos.y+.5*i.target.sprite.height;if(a){var o=Vi(1,2,e),h=1-e;Si(i.sprite,{pos:ne(s,r+43),alpha:h,frame:0,xOrigin:.5,yOrigin:.8,xScale:o,yScale:o})}if(n>0&&1>n){var l=1;.2>n?l=qi(n,0,.2,0,1):n>.75&&(l=qi(n,.75,1,1,0));var c=Vi(.5,1.5,n),d=100*n,p=-100*(4*n-4*n*n)+50;Si(i.sprite,{pos:ne(s+d,r+p),alpha:l,frame:1,xOrigin:.5,yOrigin:.5,xScale:c,yScale:c}),Si(i.sprite,{pos:ne(s-d,r+p),alpha:l,frame:2,xOrigin:.5,yOrigin:.5,xScale:c,yScale:c})}}})}function wt(t){h.call(this,t),this.sprite=xi(Je+t[0]+".png",{frames:4}),this.dizzySprite=xi("/content/battle/images/abilities/spr_dizzy.png");var i=this,e=0,a=1.75,n=18,s=0,r=0,o=0;this.anims.add(new ri([new ci(function(){return i.sprite.loaded&&i.dizzySprite.loaded}),v({actor:this.actor,duration:.7,ability:this}),new li(function(){i.fireDodge(a)}),new hi([new ri([new di({duration:1,update:function(t){s=1*t*n,s=Math.round(s),s%=2}})]),new ri([new di({duration:.25,update:function(t){e=t}}),new di({duration:.5,update:function(t){e=1}}),new di({duration:.25,update:function(t){e=1-t}})]),new ri([new di({duration:.75}),new di({duration:.25,update:function(t){r=t}}),new di({duration:.5,update:function(t){r=1}}),new di({duration:.25,update:function(t){r=1-t}})]),new ri([new di({duration:a,update:function(t){o=t*a}})])]),new li(function(){drawSplash=!1,i.fireSpritz(),i.fireKnockback()})])),this.addAfterDrawActor(function(t){if(t==i.target){var a=i.targetUndodgedPos.x+.5*i.target.sprite.frameWidth,n=i.targetUndodgedPos.y+.5*i.target.sprite.height,h=[-2,-1,0,1,2];e>0&&Si(i.sprite,{pos:ne(a+Wi(h),n),alpha:e,frame:s,xOrigin:.5,yOrigin:.5}),i.damage>0&&r>0&&(Si(i.dizzySprite,{pos:ne(a-60,n-30),alpha:r,rotation:2*-Math.PI*o*1.2,xOrigin:.5,yOrigin:.5,xScale:1.25,yScale:1.25}),Si(i.dizzySprite,{pos:ne(a+40,n-15),alpha:r,rotation:2*-Math.PI*o*.75+1,xOrigin:.5,yOrigin:.5,xScale:.8,yScale:.8}))}})}function vt(t){u.call(this,t,{alpha:.66})}function bt(t){var i=t.ability,e=t.actor,a=t.sprite,n=t.baseFrame,s=0,r=!1;return i.addAfterDrawActor(function(t){if(t===e&&r){var i=.5*e.sprite.frameWidth,o=.5*e.sprite.height,h=e.position.add(ne(i,o)),l=0;l=.25>s?qi(s,0,.25,0,1):qi(s,.25,1,1,0);var c=22*Math.PI/180*s,d=30;Si(a,{pos:h.add(ne(.33*-d,40*-s)),frame:n+0,rotation:-c,alpha:.8*l,xOrigin:.5,yOrigin:.5}),Si(a,{pos:h.add(ne(.66*+d,20*-s)),frame:n+1,rotation:1.2*+c,alpha:l,xOrigin:.5,yOrigin:.5});var p=1;.1>s?p=qi(s,0,.1,0,1):s>1&&(p=qi(s,1,1.2,1,0)),p*=Xi(s,7),Si(a,{pos:h.add(ne(0,20-50*s)),frame:n+2,alpha:p,xOrigin:.5,yOrigin:.5})}}),new ri([new di({duration:1.2,update:function(t){r=!0,s=1.2*t}}),new li(function(){r=!1})])}function yt(t){h.call(this,t),this.sprite=xi(Je+t[0]+".png",{frames:3});var i=this;this.anims.add(new ri([v({actor:this.actor,duration:.7,ability:this,blue:!0
}),bt({sprite:this.sprite,baseFrame:0,actor:this.target,ability:this}),new li(function(){i.fireSpritz()})]))}function At(t,i){h.call(this,t),this.sprite=xi(Je+t[0]+".png",{frames:i.spriteFrames}),this.sparkleSprite=xi("/content/battle/images/abilities/strip2_sapsparkles.png");var e=this;this.jawsScale=1,this.jawsAlpha=0,this.jawsFrame=0,this.anims.add(new ri([new ci(function(){return e.sprite.loaded}),new a({duration:.28,actor:this.actor,startPos:this.casterStartPos,endPos:this.casterMeleePos}),new li(function(){e.fireDodge(.9)}),new di({duration:.3,update:function(t){e.jawsScale=1+t,e.jawsAlpha=t,e.jawsFrame=i.jawsOpenFrame}}),new hi([new ri([new li(function(){e.fireKnockback(),e.fireSpritz(),i.sparkle&&e.damage>0&&e.anims.add(p({fixedPosition:e.targetUndodgedPos,actor:e.target,ability:e,sprite1:e.sparkleSprite,sprite2:e.sparkleSprite,frame1:2,frame2:3,yOffset:-30}))}),new di({duration:.3,update:function(t){e.jawsScale=1,e.jawsAlpha=1,e.jawsFrame=i.jawsClosedFrame}}),new di({duration:.3,update:function(t){e.jawsScale=1,e.jawsAlpha=1-t,e.jawsFrame=i.jawsClosedFrame}}),new li(function(){e.jawsAlpha=0}),new n({duration:.5,actor:this.actor,startPos:this.casterMeleePos,endPos:this.actor.origin})])])])),this.addAfterDrawActor(function(t){if(t===e.target&&e.jawsAlpha>0){var i=e.sprite,a=e.jawsFrame;e.target.playerControlled&&(i=Pi(i),a=i.frames-1-a);var n=.5*e.target.sprite.frameWidth,s=.5*e.target.sprite.height;Si(i,{pos:e.targetUndodgedPos.add(n,s),alpha:e.jawsAlpha,yScale:e.jawsScale,frame:a,xOrigin:.5,yOrigin:.5})}})}function xt(t){At.call(this,t,{spriteFrames:4,jawsOpenFrame:0,jawsClosedFrame:1,sparkle:!0})}function St(t){h.call(this,t),this.sprite=xi(Je+t[0]+".png",{frames:1});var i=ne(0,this.casterMeleePos.y);this.target.playerControlled&&(i.x=700-this.actor.sprite.frameWidth);var e=this,s=0;this.anims.add(new ri([new ci(function(){return e.sprite.loaded}),new a({duration:.5,actor:this.actor,startPos:this.casterStartPos,endPos:i}),new hi([new ri([new di({duration:.15}),new li(function(){e.fireDodge()})]),new ri([new n({duration:.3,actor:this.actor,startPos:i,endPos:this.casterMeleePos}),new li(function(){e.fireKnockback(),e.fireSpritz()})]),new ri([new di({duration:.3,update:function(t){e.actor.alphaMultiplier=1-t,s=t}}),new li(function(){s=0,e.actor.alphaMultiplier=1})])]),new n({duration:.5,actor:this.actor,startPos:this.casterMeleePos,endPos:this.casterEndPos})])),this.addAfterDrawActor(function(t){if(t===e.actor&&s>0){var i=e.sprite;e.target.playerControlled&&(i=Pi(i));var a=.5*e.target.sprite.frameWidth-.5*e.sprite.frameWidth,n=.5*e.target.sprite.height-.5*e.sprite.height;Si(i,{pos:e.actor.position.add(a,n),alpha:s})}})}function _t(t){h.call(this,t);var i=xi(Je+t[0]+".png",{frames:3}),e=this.actor.position,s=l(this.target);this.anims.add(new ri([new a({duration:.3,actor:this.actor,startPos:e,endPos:s}),et({actor:this.target,ability:this,sprite:i}),new n({duration:.3,actor:this.actor,startPos:s,endPos:this.actor.origin})]))}function Ct(t){tt.call(this,t,{})}function kt(t){tt.call(this,t,{})}function Et(t){tt.call(this,t,{})}function Ot(t){tt.call(this,t,{})}function Tt(t){At.call(this,t,{spriteFrames:2,jawsOpenFrame:1,jawsClosedFrame:0,sparkle:!1})}function Bt(t){u.call(this,t,{})}function Dt(t){Z.call(this,t,{})}function Pt(t){at.call(this,t,{})}function It(t){u.call(this,t,{})}function Nt(t){var i=t[1];this.update=function(t){Ia.room.actionPanel.consumableInventory.setInventory(i),Ia.room.actionQueue.endAction()},this.draw=function(t){vi()}}function Mt(t){var i=t[1];this.update=function(t){Ia.room.endBattle(i),Ia.room.actionQueue.endAction()},this.draw=function(t){vi()}}function Ft(t){this.update=function(i){var e=t[1],a=t[2],n=t[3],s=zi(e);if(s){s.health.current,s.health.max;s.health.current=a,s.health.max=n}Ia.room.actionQueue.endAction()},this.draw=function(t){vi()}}function Rt(t){var i=Ia.room.stage.firstTurn,e=t[1];Ia.room.stage.updateTurns(e);var s=zi(e[0]);Ia.room.nextActor=s,s&&s.playerControlled&&(Ia.room.actionPanel.subject=s,Ia.room.actionPanel.activate());var r=.2;if(this.anims=new hi([]),i)for(var o in Ia.room.stage.actors.arr){var h=Ia.room.stage.actors.arr[o];if(h.alive){var l=h.origin;h==s&&h.playerControlled&&(l=l.add(62,0));var c=h.position.distanceTo(l),d=c/600;this.anims.add(new a({actor:h,startPos:h.position,endPos:l,duration:d}))}else h.snapTo(h.origin)}else for(var o in Ia.room.stage.actors.arr){var h=Ia.room.stage.actors.arr[o],p=h.origin,u=h.position.distanceTo(p)/600;if(h==s&&h.playerControlled){var f=new ri([]);h.position.distanceTo(h.origin)>2&&f.add(new n({actor:h,startPos:h.position,endPos:h.origin,duration:u})),f.add(new n({actor:h,startPos:h.origin,endPos:h.origin.add(62,0),duration:r})),this.anims.add(f)}else this.anims.add(new n({actor:h,startPos:h.position,endPos:h.origin,duration:u}))}var m=0;this.update=function(t){m+=t,this.anims.update(t),this.anims.isDone()&&Ia.room.actionQueue.endAction()},this.draw=function(t){vi()}}function Lt(t){var i=Ia.room.stage.actors.arr.length;if(t.length!==i)return"mismatched actor count: server="+t.length+", client="+i;for(var e=0;e<t.length;++e){var a=t[e],n=zi(a.instanceId);if(!n)return"actor not found: "+a.instanceId;var s=n.name+" (#"+n.instanceId+")";if(n.health.current!==a.health)return"mismatched HP on actor "+s+": server="+a.health+", client="+n.health.current;if(n.breath.current!==a.breath)return"mismatched breath on actor "+s+": server="+a.breath+", client="+n.breath.current;if(n.conditions.length!==a.conditions.length)return"mismatched condition count on actor "+s+": server="+a.conditions.length+", client="+n.conditions.length;for(var r=0;r<a.conditions.length;++r){a.conditions[r]}}return null}function jt(t){this.update=function(i){var e=t[1],a=Lt(e);a&&(Ue(Da.DESYNC),alert(t[2]+": "+a)),Ia.room.actionQueue.endAction()},this.draw=function(t){vi()}}function Wt(i){var e=i[2];t.call(this,i,{getMessage:function(t){return e}})}function zt(){for(var t in Ia.room.stage.actors.arr){var i=Ia.room.stage.actors.arr[t],e=!1,a=!1,n=!1;for(var s in i.conditions){var r=i.conditions[s];"ico_reflect"==r.iconName?e=!0:"ico_bolster"==r.iconName?a=!0:"ico_ward"==r.iconName&&(n=!0)}e?(i.bubbles[_a.REFLECT].scale=1,i.bubbles[_a.REFLECT].alpha=ka.baseBubbleAlpha):(i.bubbles[_a.REFLECT].scale=0,i.bubbles[_a.REFLECT].alpha=0),a?(i.bubbles[_a.BOLSTER].scale=1,i.bubbles[_a.BOLSTER].alpha=ka.baseBubbleAlpha):(i.bubbles[_a.BOLSTER].scale=0,i.bubbles[_a.BOLSTER].alpha=0),n?(i.bubbles[_a.WARD].scale=1,i.bubbles[_a.WARD].alpha=ka.baseBubbleAlpha):(i.bubbles[_a.WARD].scale=0,i.bubbles[_a.WARD].alpha=0)}}function Yt(t){for(var i in Ia.room.stage.actors.arr)for(var e=Ia.room.stage.actors.arr[i],a=0;a<e.conditions.length;++a){var n=e.conditions[a];if(n.instanceId==t)return void e.conditions.splice(a,1)}}function Ht(t){this.instanceId=t[1],this.update=function(t){Yt(this.instanceId),zt(),Ia.room.actionQueue.endAction()},this.draw=function(t){vi()}}function Ut(t){this.init=!1,this.caster=zi(t[1]),this.target=zi(t[2]),this.instanceId=t[3][0],this.icon=t[3][1],this.name=t[3][2],this.desc=t[3][3],this.turns=t[3][4],this.update=function(t){if(!this.init){new de({caster:this.caster,target:this.target,instanceId:this.instanceId,icon:this.icon,name:this.name,desc:this.desc,turns:this.turns});zt(),this.init=!0}Ia.room.actionQueue.endAction()},this.draw=function(t){vi()}}function Gt(t){this.init=!1,this.target=zi(t[1]),this.amount=t[2],this.heal=t[3],this.targetWasAlive=this.target.alive,this.update=function(t){this.targetWasAlive&&(this.init||(this.spritz=new me({amount:this.amount,target:this.target,heal:this.heal}),this.init=!0)),Ia.room.actionQueue.endAction()},this.draw=function(t){vi()}}function Vt(t){this.init=!1,this.target=zi(t[1]),this.amount=t[2],this.heal=t[3],this.update=function(t){this.target.alive&&(this.init||(this.spritz=new me({amount:this.amount,target:this.target,breath:!0,heal:this.heal}),this.init=!0)),Ia.room.actionQueue.endAction()},this.draw=function(t){vi()}}function $t(t){this.update=function(t){Ia.room.actionQueue.endAction()},this.draw=function(t){vi()}}function qt(t,i){return xi(Je+t+".png",i)}function Xt(t,i){h.call(this,t);var e=0;i.yOffset&&(e=i.yOffset),this.sprite=qt(this.abilityId),this.spriteAlpha=0;var a=this;this.anims.add(new ri([new ci(function(){return a.sprite.loaded}),new di({duration:.25,update:function(t){a.actor.snapTo(a.casterMeleePos),a.spriteAlpha=t}}),new di({duration:.2,update:function(t){a.spriteAlpha=1}}),new di({duration:.25,update:function(t){a.spriteAlpha=1-t}}),new li(function(){a.fireSpritz()})])),this.addAfterDrawActor(function(t){if(t===a.target&&a.spriteAlpha>0){var i=a.sprite;a.target.playerControlled&&(i=Pi(i)),Si(i,{pos:a.simpleTargetCenter.add(0,e),xOrigin:.5,yOrigin:.5,alpha:a.spriteAlpha})}})}function Kt(t,i){h.call(this,t),this.sprite=qt(this.abilityId,{frames:2}),this.spriteAlpha=0;var e=this;this.anims.add(new ri([new ci(function(){return e.sprite.loaded}),new di({duration:.25,update:function(t){e.spriteAlpha=t}}),new di({duration:.5,update:function(t){e.spriteAlpha=1}}),new di({duration:.25,update:function(t){e.spriteAlpha=1-t}}),new li(function(){e.fireSpritz()})])),this.addAfterDrawActor(function(t){if(t===e.target&&e.spriteAlpha>0){var i=e.sprite;e.target.playerControlled&&(i=Pi(i)),Si(i,{pos:e.simpleTargetCenter,xOrigin:.5,yOrigin:.5,frame:0,alpha:e.spriteAlpha}),Si(i,{pos:e.simpleTargetCenter,xOrigin:.5,yOrigin:.5,frame:1,alpha:e.spriteAlpha})}})}function Qt(t){var i=t.ability;return new ri([new di({duration:.25,update:function(t){i.reflectedByActor.bubbles[_a.REFLECT].alpha=Vi(ka.baseBubbleAlpha,1,t)}}),new di({duration:.25,update:function(t){i.reflectedByActor.bubbles[_a.REFLECT].alpha=Vi(1,ka.baseBubbleAlpha,t)}})])}function Zt(t){function i(){return ne(.5*a.sprite.frameWidth,20+.5*h.height)}var e=t.ability,a=t.actor,n=.7,s=.88,r=1,o=0,h=xi("/content/battle/images/abilities/strip8_casting.png"),l=t.blue?4:0;e.addBeforeDrawActor(function(t){t===a&&Si(h,{pos:a.origin.add(i()),alpha:o,frame:l,xScale:s,yScale:r,xOrigin:.5,yOrigin:.5})}),e.addAfterDrawActor(function(t){t===a&&Si(h,{pos:a.origin.add(i()),alpha:o,frame:l+1,xScale:s,yScale:r,xOrigin:.5,yOrigin:.5})});var c=[new ci(function(){return h.loaded}),new di({duration:.333*n,update:function(t){o=t}}),new di({duration:.333*n,update:function(t){o=1}}),new di({duration:.333*n,update:function(t){o=1-t}}),new li(function(){o=0})];return e.reflected&&c.push(Qt({ability:e})),new ri(c)}function Jt(t,i){h.call(this,t),this.sprite=qt(this.abilityId),this.spriteAlpha=0;var e=this;this.anims.add(new ri([new ci(function(){return e.sprite.loaded}),Zt({ability:this,actor:this.actor}),new di({duration:.2,update:function(t){e.spriteAlpha=t}}),new di({duration:.1,update:function(t){e.spriteAlpha=1}}),new di({duration:.25,update:function(t){e.spriteAlpha=1-t}}),new li(function(){e.fireSpritz()})])),this.addAfterDrawActor(function(t){if(t===e.target&&e.spriteAlpha>0){var i=e.sprite;e.target.playerControlled&&(i=Pi(i));var a=0;a=e.target.playerControlled?.5*e.target.sprite.frameWidth:.5*-e.target.sprite.frameWidth,Si(i,{pos:e.simpleTargetCenter.add(a,0),xOrigin:.5,yOrigin:.5,alpha:e.spriteAlpha})}})}function ti(t,i){h.call(this,t),this.duration=1,void 0!==i.duration&&(this.duration=i.duration),this.spriteAlpha=0,this.spriteDrawCenter=this.simpleTargetCenter;var e=this;this.duration<.5?(this.fadeInTime=.5*this.duration,this.fadeOutTime=this.fadeInTime,this.sustainTime=0):(this.fadeInTime=.25,this.fadeOutTime=.25,this.sustainTime=this.duration-.5),this.anims.add(new ri([new ci(function(){return e.sprite.loaded}),Zt({ability:this,actor:this.actor,blue:i.blue}),new di({duration:this.fadeInTime,update:function(t){e.spriteAlpha=t}}),new di({duration:this.sustainTime,update:function(t){e.spriteAlpha=1}}),new di({duration:this.fadeOutTime,update:function(t){e.spriteAlpha=1-t}}),new li(function(){e.fireSpritz()})]))}function ii(t,i){ti.call(this,t,{duration:1.7,blue:i.blue}),this.sprite=qt(this.abilityId,{frames:4});var e=this;this.addBeforeDrawActor(function(t){if(t===e.target&&e.spriteAlpha>0){var i=e.sprite;Si(i,{pos:ne(e.spriteDrawCenter.x,e.simpleTargetPos.y),xOrigin:.5,yOrigin:0,frame:0,alpha:e.spriteAlpha})}}),this.addAfterDrawActor(function(t){if(t===e.target&&e.spriteAlpha>0){var i=e.sprite;Si(i,{pos:ne(e.spriteDrawCenter.x,e.simpleTargetPos.y),xOrigin:.5,yOrigin:0,frame:1,alpha:e.spriteAlpha}),Si(i,{pos:e.spriteDrawCenter,xOrigin:.5,yOrigin:.5,frame:2,alpha:e.spriteAlpha}),Si(i,{pos:e.spriteDrawCenter,xOrigin:.5,yOrigin:.5,frame:3,alpha:e.spriteAlpha})}})}function ei(t,i){h.call(this,t);var e=this.target.bubbles[i.bubbleType];this.spriteAlpha=0;var a=this;this.anims.add(new ri([Zt({ability:this,actor:this.actor,blue:!0}),new di({duration:.25,update:function(t){e.alpha=Vi(ka.baseBubbleAlpha,1,t),e.scale=1}}),new di({duration:.8,update:function(t){e.alpha=1,e.scale=1}}),new di({duration:.25,update:function(t){e.alpha=Vi(1,ka.baseBubbleAlpha,t),e.scale=1}}),new li(function(){a.fireSpritz()})]))}function ai(t){ti.call(this,t,{duration:1.2,blue:!0}),this.sprite=qt(this.abilityId,{frames:3});var i=this;this.addAfterDrawActor(function(t){t==i.target&&i.spriteAlpha>0&&(Si(i.sprite,{pos:i.spriteDrawCenter,alpha:i.spriteAlpha,xOrigin:.5,yOrigin:.5,frame:1}),Si(i.sprite,{pos:i.spriteDrawCenter.add(ne(0,-20)),xOrigin:.5,yOrigin:.5,alpha:i.spriteAlpha,frame:2}))})}function ni(t,i){h.call(this,t),this.sprite=qt(this.abilityId,{frames:4}),this.spriteAlpha=0,this.aidAlpha=0;var e=this;this.anims.add(new ri([new ci(function(){return e.sprite.loaded}),new di({duration:.25,update:function(t){e.spriteAlpha=t}}),new di({duration:.5,update:function(t){e.spriteAlpha=1}}),new di({duration:.25,update:function(t){e.spriteAlpha=1-t}}),new di({duration:.25,update:function(t){e.aidAlpha=t}}),new di({duration:.45,update:function(t){e.aidAlpha=1}}),new di({duration:.25,update:function(t){e.aidAlpha=1-t}}),new li(function(){e.fireSpritz()})])),this.addAfterDrawActor(function(t){if(t===e.target&&(e.spriteAlpha>0||e.aidAlpha>0)){var i=e.sprite;Si(i,{pos:e.simpleTargetCenter,xOrigin:.5,yOrigin:.5,alpha:e.spriteAlpha,frame:0}),Si(i,{pos:e.simpleTargetCenter,xOrigin:.5,yOrigin:.5,alpha:e.aidAlpha,frame:1}),Si(i,{pos:e.simpleTargetCenter,xOrigin:.5,yOrigin:.5,alpha:e.aidAlpha,frame:3})}})}function si(t,i){h.call(this,t),this.duration=1,void 0!==i.duration&&(this.duration=i.duration),this.sprite=qt(this.abilityId,{frames:3}),this.spriteAlpha=0;var e=this;this.anims.add(new ri([new ci(function(){return e.sprite.loaded}),new di({duration:.25,update:function(t){e.spriteAlpha=t}}),new di({duration:this.duration-.5,update:function(t){e.spriteAlpha=1}}),new di({duration:.25,update:function(t){e.spriteAlpha=1-t}}),new li(function(){e.fireSpritz()})])),this.addAfterDrawActor(function(t){if(t===e.target&&e.spriteAlpha>0){var i=e.sprite;Si(i,{pos:e.simpleTargetCenter,xOrigin:.5,yOrigin:.5,frame:2,alpha:e.spriteAlpha})}})}function ri(t){this._sequence=t.slice(),this._pos=0}function oi(t,i){ri.call(this,i),this._condFunc=t,this._evalResult=void 0}function hi(t){this._anims=[],t&&(this._anims=t.slice())}function li(t){this._func=t,this._fired=!1}function ci(t){this._func=t,this._done=!1}function di(t){this._duration=1,void 0!==t.duration&&(this._duration=t.duration),this._t=0,this._start=t.start,this._updateFunc=t.update,this._updateFunc||(this._updateFunc=function(t){}),this._finish=t.finish,this._started=!1,this._finished=!1}function pi(t){this._animMaker=t,this._anim=null,this._done=!1}function ui(t){var i=ne(0,0);return window.innerWidth!=screen.width||window.innerHeight!=screen.height?(i.x=t.pageX-$("#cnv").offset().left,i.y=t.pageY-$("#cnv").offset().top):(i.x=t.offsetX,i.y=t.offsetY),ne(i.x,i.y)}function fi(t){var i=ne(0,0);return i.x=t.pageX-$("#cnv").offset().left,i.y=t.pageY-$("#cnv").offset().top,ne(i.x,i.y)}function mi(t,i){if(t.keyBind&&(t.keyBind.obj=t),!t.position&&!t.pos||!t.sprite&&!i)return!1;t.sprite&&!i?(i=t.sprite,i.frames=t.sprite.frames):i.frames=1,i&&!i.frames&&(i.frames=1);var e=i.width/i.frames,a=i.height,n=!0,s=t.position||t.pos;return(void 0!=t.active&&!t.active||ea.x<s.x||ea.y<s.y||ea.x>s.x+e||ea.y>s.y+a)&&(n=!1),n?(fa=t,t.cursor&&(aa.style.cursor=t.cursor)):fa==t&&(aa.style.cursor="default",fa=!1),Ia.mouseoverRects.rects.push({pos:ne(s.x,s.y),w:e,h:a,mouseOverObj:t}),fa}function gi(){this.rects=[],this.clearMouseoverRects=function(){this.rects=[]},this.draw=function(){},this.findObjectAtPosition=function(t){var i=null;for(var e in this.rects){var a=this.rects[e],n=a.mouseOverObj;(n.active||void 0===n.active)&&t.x>=a.pos.x&&t.y>=a.pos.y&&t.x<a.pos.x+a.w&&t.y<a.pos.y+a.h&&(i=a)}return i?i.mouseOverObj:null}}function wi(t){ma.indexOf(t)>-1||ma.push(t)}function vi(t){Ia.room.stage.actors.draw(t)}function bi(t,i,e,a,n){void 0===n&&(n=!0);var s=.5522848,r=e/2*s,o=a/2*s,h=t+e,l=i+a,c=t+e/2,d=i+a/2;na.beginPath(),na.moveTo(t,d),na.bezierCurveTo(t,d-o,c-r,i,c,i),na.bezierCurveTo(c+r,i,h,d-o,h,d),na.bezierCurveTo(h,d+o,c+r,l,c,l),na.bezierCurveTo(c-r,l,t,d+o,t,d),na.closePath(),n?na.fill():na.stroke()}function yi(t){void 0==t&&(t={});var i=t.size||10,e=t.bold||!1,a=t.italic||!1,n=t.family||t.name||t.face||"Arial",s="";a&&(s+="italic "),e&&(s+="bold "),s+=i+"px ",s+=n,na.font=s}function Ai(){Qe=[]}function xi(t,i){if(Qe[t])return i&&i.frames&&(Qe[t].frames=i.frames,Qe[t].frameWidth=Qe[t].width/Qe[t].frames),Qe[t];i||(i={});var e=new Image;Qe[t]=e,e.loaded=!1;var a=i.frames||1;return t.indexOf("strip")>-1&&(a=parseInt(t.slice(t.indexOf("strip")+5,t.indexOf("_")))),e.frames=a,e.onload=function(){this.loaded=!0,this.frameWidth=this.width/this.frames},e.onerror=function(){},e.debugName=t,e.src=t,e}function Si(t,i){if("string"==typeof t&&(t=xi(t)),"object"==typeof t&&t.loaded){var e=1;if(!(void 0!==t.alpha&&(e=t.alpha,0>=e)||(i||(i={}),void 0!==i.alpha&&(e=i.alpha,0>=e)))){var a=na.globalAlpha;i||(i={}),void 0==i.shadow&&(i.shadow={}),1==i.shadow&&(i.shadow={color:"black",x:1,y:1});var n=i.partialX||0,s=i.partialY||0,r=i.partialWidth||t.frameWidth,o=i.partialHeight||t.height,h=void 0!==i.xScale?i.xScale:1,l=void 0!==i.yScale?i.yScale:1,c=i.x||0,d=i.y||0,p=i.width||t.frameWidth,u=i.height||t.height,f=i.shadow.color||"black",m=i.shadow.x||0,g=i.shadow.y||0,w=i.shadow.blur||0,v=void 0!==i.xOrigin?i.xOrigin:0,b=void 0!==i.yOrigin?i.yOrigin:0,y=i.flip||0;y&&(t.flip||(t.flip=Pi(t)),t=t.flip),i.frame&&(n+=t.frameWidth*(Math.floor(i.frame)%t.frames)),i.pos&&(c=i.pos.x,d=i.pos.y);var A=-v*p,x=-b*u;if(void 0!==i.percent){if(i.percent<=0)return;i.percent>1&&(i.percent=1),p*=i.percent,r*=i.percent}if(void 0!==i.percentVert){if(i.percentVert<=0)return;i.percentVert>1&&(i.percentVert=1),i.percentVertReverse&&(x+=u*(1-i.percentVert),s+=o*(1-i.percentVert)),u*=i.percentVert,o*=i.percentVert}if(c=Math.round(c),d=Math.round(d),A=Math.round(A),x=Math.round(x),e=ee(e),!(0>=e)){var S=0;if(i.rotation&&(S=i.rotation),na.shadowColor=f,na.shadowOffsetX=m,na.shadowOffsetY=g,na.shadowBlur=w,na.globalAlpha=e,S||1!==h||1!==l){var _=na.getXform(),C=_;C=te(C,Qi(c,d)),C=te(C,Ji(S)),C=te(C,Zi(h,l)),na.setXform(C),na.drawImage(t,n,s,r,o,A,x,p,u),na.setXform(_)}else na.drawImage(t,n,s,r,o,c+A,d+x,p,u);i.debug&&wi("sx: "+n+", sy: "+s+", sw: "+r+", sh: "+o+", x: "+c+", y: "+d+", w: "+p+", h: "+u),Ti(),na.shadowColor="rgba(0, 0, 0, 0)",na.globalAlpha=a}}}}function _i(t,i){var e=Math.round(t[0])+.5,a=Math.round(t[1])+.5,n=Math.round(i[0])+.5,s=Math.round(i[1])+.5;na.beginPath(),na.moveTo(e,a),na.lineTo(n,s),na.stroke()}function Ci(t){if(!t.loaded)return null;if(ba[t.src])return ba[t.src];var i=na.createPattern(t,"repeat");return ba[t.src]=i,i}function ki(t){var i=na.globalAlpha;if(ga.px1.visible&&ga.px1.alpha>0){na.globalAlpha=ga.px1.alpha;var e=Ia.room.stage.position.x+ga.px1.position.x+ga.px1.wave.x,a=Ia.room.stage.position.y+ga.px1.position.y+ga.px1.wave.y,n=Ci(t.parallax1);n&&(na.rect(Ia.room.stage.position.x,Ia.room.stage.position.y,wa,va),na.fillStyle=n,na.translate(e,a),na.fill(),na.translate(-e,-a))}if(ga.px2.visible&&ga.px2.alpha>0){na.globalAlpha=ga.px2.alpha;var e=Ia.room.stage.position.x+ga.px2.position.x+ga.px2.wave.x,a=Ia.room.stage.position.y+ga.px2.position.y+ga.px2.wave.y,n=Ci(t.parallax2);n&&(na.rect(Ia.room.stage.position.x,Ia.room.stage.position.y,wa,va),na.fillStyle=n,na.translate(e,a),na.fill(),na.translate(-e,-a))}na.globalAlpha=i}function Ei(t){t.position.x>wa&&(t.position.x-=wa),t.position.x<-wa&&(t.position.x+=wa),t.position.y>va&&(t.position.y-=va),t.position.y<-va&&(t.position.y+=va)}function Oi(t){void 0==t&&(t={}),t.pos||(t.pos=ne()),t.end||(t.end={}),Ti(t);var i=Ui(t.pos.x),e=Ui(t.pos.y),a=t.width||t.end.x-i||1,n=t.height||t.end.y-e||1;a=Ui(a),n=Ui(n),0!=t.filled?na.fillRect(i,e,a,n):na.strokeRect(i,e,a,n)}function Ti(t){void 0==t&&(t={});var i=t.shadow;void 0===i?i={color:"transparent",x:0,y:0}:i===!0&&(i={color:"black",x:1,y:1});var e=t.color||"white",a=t.halign||"left",n=t.valign||"top",s=i.color||"black",r=i.x||0,o=i.y||0;na.fillStyle=e,na.strokeStyle=e,na.shadowColor=s,na.shadowOffsetX=r,na.shadowOffsetY=o,na.textAlign=a,na.textBaseline=n}function Bi(t){if(void 0!=t){"object"!=typeof t&&(t={text:t.toString()}),void 0==t.pos&&(t.pos=ne());var i=1;void 0!==t.alpha&&(i=t.alpha);var e=na.globalAlpha;na.globalAlpha=i,yi(t),Ti(t);var a=Ui(t.pos.x),n=Ui(t.pos.y);if(t.simpleShadowOffset){var s=a+t.simpleShadowOffset.x,r=n+t.simpleShadowOffset.y,o=t.color;t.color="black",Ti(t),na.fillText(t.text,s,r),t.color=o}Ti(t),na.fillText(t.text,a,n),Ti(),na.globalAlpha=e}}function Di(t){if(void 0!=t){"object"!=typeof t&&(t={text:t.toString()}),void 0==t.pos&&(t.pos=ne()),Ti(t),yi(t);var i=(Ui(t.pos.x),Ui(t.pos.y),na.measureText(t.text).width);return Ti(),i}}function Pi(t){if(t.flip)return t.flip;!t.loaded,sa.width=t.width,sa.height=t.height,ra.setTransform(-1,0,0,1,0,0),ra.drawImage(t,-sa.width,0);var i=sa.toDataURL(),e=new Image;return e.onload=function(){this.frameWidth=t.frameWidth,this.loaded=!0,this.frames=t.frames},e.src=i,e.flip=t,e.debugName="FLIP:"+t.debugName,t.flip=e,e}function Ii(t,i){i.px1.position.y-=40*t,i.px2.position.y-=60*t;var e=4,a=15;i.px1.time=(i.px1.time+t)%e,i.px1.wave.x=Math.sin(i.px1.time/e*2*Math.PI)*a;var n=6,s=12;i.px2.time=(i.px2.time+t)%n,i.px2.wave.x=Math.sin(i.px2.time/n*2*Math.PI)*s,Ei(i.px1),Ei(i.px2)}function Ni(t,i){i.px1.position.y-=40*t,i.px2.position.y-=60*t;var e=4,a=5;i.px1.time=(i.px1.time+t)%e,i.px1.wave.x=Math.sin(i.px1.time/e*2*Math.PI)*a;var n=6,s=10;i.px2.time=(i.px2.time+t)%n,i.px2.wave.x=Math.sin(i.px2.time/n*2*Math.PI)*s,Ei(i.px1),Ei(i.px2)}function Mi(t,i){if(Ia.options.flashes){var e=30,a=.05,n=.66;i.px1.time=(i.px1.time+t)%e,i.px1.time>=e-n?(i.px1.visible=!0,i.px1.alpha=qi(i.px1.time,e-n,e,1,0)):i.px1.time>=e-a-n?(i.px1.visible=!0,i.px1.alpha=qi(i.px1.time,e-a-n,e-n,0,1)):i.px1.visible=!1;var s=20,r=.5,o=.25;i.px2.counter++,i.px2.counter%=4,i.px2.time=(i.px2.time+t)%s,i.px2.time>=s-o?i.px2.visible=i.px2.counter%4==0:i.px2.time>=s-r-o?i.px2.visible=i.px2.counter%2==0:i.px2.visible=!1}else i.px1.visible=!1,i.px2.visible=!1}function Fi(t,i){var e=ya.intensity;i.px1.position.x+=(10+e)*t,i.px1.position.y+=40*t,i.px2.position.x+=1.5*(15+e)*t,i.px2.position.y+=60*t,Ei(i.px1),Ei(i.px2)}function Ri(t,i,e,a){t=Li(t),i=Li(i),e=Li(e),a=ee(a),Ia.options.animations||(a=1);var n="rgba("+t+","+i+","+e+","+a+")";return n}function Li(t){return t?t>255?255:Ui(t):0}function ji(t,i,e,a){var n;void 0===t&&(n="black"),void 0===i?n=t:(void 0===e&&(e=0),void 0===a&&(a=1),n="rgba("+t+", "+i+", "+e+", "+a+")"),na.fillStyle=n,na.strokeStyle=n}function Wi(t){return t[Math.floor(Math.random()*t.length)]}function zi(t){var i=Ia.room.stage.actors.arr;for(var e in i)if(i[e].instanceId==t)return i[e];return!1}function Yi(t,i,e){return i>t+e?t+=e:t-e>i?t-=e:t=i,t}function Hi(t,i){void 0==i&&(i=0),socket.emit(Ke.useTurn,[Ia.room.stage.turns.turnOrder[0],t,i]),Ia.room.actionPanel.deactivate()}function Ui(t){return Math.round(t)}function Gi(t,i,e){return i>t?i:t>e?e:t}function Vi(t,i,e){return t*(1-e)+i*e}function $i(t,i,e){return ne(Vi(t.x,i.x,e),Vi(t.y,i.y,e))}function qi(t,i,e,a,n){var t=(t-i)/(e-i);return t=Gi(t,0,1),Vi(a,n,t)}function Xi(t,i){return.5+.5*Math.sin(2*t*Math.PI*i)}function Ki(){return[1,0,0,1,0,0]}function Qi(t,i){return[1,0,0,1,t,i]}function Zi(t,i){return[t,0,0,i,0,0]}function Ji(t){var i=Math.cos(t),e=Math.sin(t);return[i,e,-e,i,0,0]}function te(t,i){var e=[0,0,0,0,0,0];return e[0]=t[0]*i[0]+t[2]*i[1],e[1]=t[1]*i[0]+t[3]*i[1],e[2]=t[0]*i[2]+t[2]*i[3],e[3]=t[1]*i[2]+t[3]*i[3],e[4]=t[0]*i[4]+t[2]*i[5]+t[4],e[5]=t[1]*i[4]+t[3]*i[5]+t[5],e}function ie(t){return t=Gi(t,0,1),-t*t+2*t}function ee(t){return!t||0>=t?0:t>=1?1:Math.round(100*t)/100}function ae(t,i){this.x=t||0,this.y=i||0,this.copy=function(){return ne(this.x,this.y)},this.length=function(){return Math.sqrt(this.x*this.x+this.y*this.y)},this.zero=function(){return ne(0,0)},this.norm=function(){var t=this.length();return 1e-6>=t?ne(1,0):this.div(t)},this.equals=function(t){return Math.round(this.x)!=Math.round(t.x)||Math.round(this.y)!=Math.round(t.y)?!1:!0},this.add=function(t,i){return void 0!==i&&(t=ne(t,i)),ne(this.x+t.x,this.y+t.y)},this.sub=function(t){return ne(this.x-t.x,this.y-t.y)},this.mul=function(t){return t.hasOwnProperty("x")?ne(this.x*t.x,this.y*t.y):ne(this.x*t,this.y*t)},this.div=function(t){return t.hasOwnProperty("x")?ne(this.x/t.x,this.y/t.y):ne(this.x/t,this.y/t)},this.distanceTo=function(t){return this.sub(t).length()},this.directionTo=function(t){return t.sub(this).norm()},this.movedTowards=function(t,i){var e=t.sub(this);return e.length()<=i?t.copy():this.add(e.norm().mul(i))}}function ne(t,i){return new ae(t,i)}function se(t){var i=t;Ai(),Ia.room=new Re,Ia.room.stage.venueId=i[0],Ia.room.stage.venueNum=i[4],Ia.enemies=[];var e=0;for(var a in i[1]){var n=i[1][a];"dragon"==n[10]?(newEnemy=new ge(n,a,!0),newEnemy.sprite.frames=1):(newEnemy=new we(n),newEnemy.sprite.frames=n[4]),newEnemy.playerControlled=!1,Ia.enemies.push(newEnemy),Ia.room.stage.actors.push(newEnemy),newEnemy.defaultKeyBind=null,e<Ia.enemyBinds.length&&(newEnemy.defaultKeyBind=Ia.enemyBinds[e],++e)}var s=0;for(var a in i[2]){var r=new Be,o=i[2][a],h=new ge(o,a,!1);h.playerControlled=!0,r.party.push(h),Ia.room.stage.actors.push(h),h.defaultKeyBind=null,s<Ia.friendlyBinds.length&&(h.defaultKeyBind=Ia.friendlyBinds[s],++s)}Ia.room.unitFrames.initialize(),i[3]?Ia.room.pvp=!0:Ia.room.pvp=!1}function re(t,i){if(!t[1])return this.update=function(){},void(this.draw=function(){});switch(this.slot=i,this.position=ne(Aa[i].x+5,Aa[i].y+5),this.active=!0,this.abilityId=t[1],this.itemid=t[0],this.abilitySprite=xi("/images/cms/abilities/"+t[1]+".png"),$e[t[1]]?this.action=$e[t[1]]:this.action=$e[0],i){case 0:this.keyBind=Ia.key_e;break;case 1:this.keyBind=Ia.key_a;break;case 2:this.keyBind=Ia.key_s;break;case 3:this.keyBind=Ia.key_d;break;case 4:this.keyBind=Ia.key_f}this.targeting=da.ENEMY,this.cost=0,this.affectedBySilence=!0,oa[this.abilityId]&&(this.targeting=oa[this.abilityId].targeting,this.cost=oa[this.abilityId].breathCost,this.affectedBySilence=oa[this.abilityId].affectedBySilence),this.sprite=xi("/images/cms/battle_items/"+this.itemid+".png"),this.canBeUsedBy=function(t){return this.affectedBySilence&&t.isSilenced()?!1:void 0!==this.cost&&t.breath.current>=this.cost},this.update=function(t){var i=zi(Ia.room.stage.turns.turnOrder[0]);this.canBeUsedBy(i)?this.cursor="pointer":this.cursor="default";var e={width:xa-10,height:xa-10},a=mi(this,e);a==this?Ia.tooltip.showTip(this.itemid,"battle_items",ne(213,196)):Ia.tooltip.tipID==this.itemid&&Ia.tooltip.hideTip()},this.draw=function(){var t="white",i=.5,e=zi(Ia.room.stage.turns.turnOrder[0]);this.canBeUsedBy(e)?i=1:t="#FF3333",this.cost<1&&(t="#CCCCFF"),Si(this.sprite,{x:this.position.x-5,y:this.position.y-5,width:xa,height:xa,alpha:i}),Bi({text:Math.abs(this.cost),pos:this.position.add(xa-12,xa-12),bold:!0,italic:!0,size:14,family:"Verdana",halign:"right",valign:"bottom",color:t,simpleShadow:!0,simpleShadowOffset:ne(1,1)}),this.keyBind.draw(this.position.x+17,this.position.y-10)},this.cursor="pointer",this.leftClick=function(t){var i=zi(Ia.room.stage.turns.turnOrder[0]);this.canBeUsedBy(i)&&Ia.room.actionPanel.enterTargeting(i,this.abilityId,this.targeting)}}function oe(){this.selection=!1,this.subject=!1,this.validTargets=[],this.consumableInventory=new ue,this.activate=function(){this.buttons.useAbility.active=!0,this.buttons.useDefend.active=!0,this.buttons.useFlee.active=!0,Ia.room.pvp||(this.buttons.useItem.active=!0)},this.deactivate=function(){this.selection=!1,this.buttons.useAbility.active=!1,this.buttons.useDefend.active=!1,this.buttons.useFlee.active=!1,this.buttons.useItem.active=!1,this.deactivateTargeting()},this.deactivateTargeting=function(){this.validTargets=[];for(var t in Ia.room.stage.actors.arr){var i=Ia.room.stage.actors.arr[t];i.leftClick=!1,i.cursor="default",i.keyBind=!1}},this.enterTargeting=function(t,i,e){this.lastSelection=this.selection,this.validTargets=[];var a=Ia.room.stage.actors.arr;switch(e){case da.ENEMY:this.selection="targeting";for(var n in a){var s=a[n];!s.playerControlled&&s.health.current>0&&this.validTargets.push(s)}break;case da.FRIENDLY:this.selection="targeting";for(var n in a){var s=a[n];s.playerControlled&&s.health.current>0&&this.validTargets.push(s)}break;case da.FRIENDLY_NOT_SELF:this.selection="targeting";for(var n in a){var s=a[n];s!==t&&s.playerControlled&&s.health.current>0&&this.validTargets.push(s)}break;case da.ANY:this.selection="targeting";for(var n in a){var s=a[n];s.health.current>0&&this.validTargets.push(s)}break;case da.SELF:default:Hi(i,t.instanceId)}if(this.validTargets.length)for(var n in this.validTargets){var r=this.validTargets[n];r.keyBind=r.defaultKeyBind,r.leftClick=function(){Hi(i,this.instanceId)},r.cursor="pointer"}Ia.tooltip.hideTip()},this.initialized=!1,this.position={x:414,y:381},this.initialize=function(){var t="/content/battle/images/",i=this;this.buttons={useAbility:{keyBind:Ia.key_a,position:{x:i.position.x+7,y:i.position.y+19},sprite:xi(t+"strip2_useAbility.png"),update:function(t){this.active&&mi(this)},leftClick:function(t){this.active&&(i.selection=this)},active:!1,draw:function(){Si(this.sprite,{x:this.position.x,y:this.position.y,frame:this.active}),this.active&&this.keyBind.draw(this.position.x+this.sprite.frameWidth/2-this.keyBind.sprite.frameWidth/2,this.position.y-12)},cursor:"pointer"},useItem:{keyBind:Ia.key_s,position:{x:i.position.x+104,y:i.position.y+19},sprite:xi(t+"strip2_useItem.png"),update:function(t){this.active&&mi(this)},leftClick:function(t){this.active&&(i.selection=this)},active:!1,draw:function(){Si(this.sprite,{x:this.position.x,y:this.position.y,frame:this.active}),this.active&&this.keyBind.draw(this.position.x+this.sprite.frameWidth/2-this.keyBind.sprite.frameWidth/2,this.position.y-12)},cursor:"pointer"},useDefend:{keyBind:Ia.key_d,position:{x:i.position.x+200,y:i.position.y+19},sprite:xi(t+"strip2_useDefend.png"),update:function(t){this.active&&mi(this)},leftClick:function(t){this.active&&Hi("defend")},active:!1,draw:function(){Si(this.sprite,{x:this.position.x,y:this.position.y,frame:this.active}),this.active&&this.keyBind.draw(this.position.x+this.sprite.frameWidth/2-this.keyBind.sprite.frameWidth/2,this.position.y-12)},cursor:"pointer"},useFlee:{keyBind:Ia.key_f,position:{x:i.position.x+200,y:i.position.y+96},sprite:xi(t+"strip2_useFlee.png"),update:function(t){this.active&&mi(this)},leftClick:function(t){this.active&&(Ia.room.modal=fleeModal)},active:!1,draw:function(){Si(this.sprite,{x:this.position.x,y:this.position.y,frame:this.active}),this.active&&this.keyBind.draw(this.position.x+this.sprite.frameWidth/2-this.keyBind.sprite.frameWidth/2,this.position.y+this.sprite.height-12)},cursor:"pointer"},abilitiesMenu:{position:{x:i.position.x,y:i.position.y},sprite:xi(t+"spr_abilitiesMenu.png"),update:function(t){mi(this.cancelButton)},cancelButton:{keyBind:Ia.key_esc,active:!0,position:i.position,cursor:"pointer",sprite:{width:40,height:40,frames:1},
leftClick:function(t){i.selection=!1,i.activate()}},draw:function(){Si(this.sprite,{x:this.position.x,y:this.position.y,frame:0}),this.cancelButton.keyBind.draw(this.position.x+5,this.position.y-13)}},abilityCancel:{keyBind:Ia.key_esc,position:{x:i.position.x+70,y:i.position.y+103},sprite:xi(t+"spr_abilityCancel.png"),update:function(t){mi(this)},cursor:"pointer",leftClick:function(){i.selection=i.lastSelection,i.deactivateTargeting()},draw:function(){Si(this.sprite,{x:this.position.x,y:this.position.y,frame:0}),this.keyBind.draw(this.position.x+62,this.position.y-15)}},itemsMenu:{position:{x:i.position.x,y:i.position.y},sprite:xi(t+"spr_itemsMenu.png"),update:function(t){mi(this.cancelButton),i.consumableInventory.update(t)},cancelButton:{keyBind:Ia.key_esc,active:!0,position:i.position,cursor:"pointer",sprite:{width:40,height:40,frames:1},leftClick:function(t){i.selection=!1,i.activate()}},draw:function(){Si(this.sprite,{x:this.position.x,y:this.position.y,frame:0}),this.cancelButton.keyBind.draw(this.position.x+5,this.position.y-13),i.consumableInventory.draw()}}},this.initialized=!0},this.update=function(t){switch(this.selection){case"targeting":this.buttons.abilityCancel.update(t);break;case this.buttons.useAbility:this.buttons.abilitiesMenu.update(t);for(var i in this.subject.abilities)this.subject.abilities[i].update(t);break;case this.buttons.useItem:this.buttons.itemsMenu.update(t);break;default:this.buttons.useAbility.update(t),this.buttons.useDefend.update(t),this.buttons.useFlee.update(t),this.buttons.useItem.update(t)}},this.draw=function(){switch(this.selection){case"targeting":this.buttons.abilityCancel.draw();break;case this.buttons.useAbility:this.buttons.abilitiesMenu.draw();for(var t in this.subject.abilities)this.subject.abilities[t].draw();break;case this.buttons.useItem:this.buttons.itemsMenu.draw();break;case this.buttons.useFlee:default:this.buttons.useAbility.draw(),this.buttons.useDefend.draw(),this.buttons.useFlee.draw(),this.buttons.useItem.draw()}},this.initialize()}function he(){this.arr=[],this.push=function(t){this.arr.push(t)},this.wait=function(){},this.endAction=function(){Ia.room.currentAction=!1},this.update=function(t){if(this.arr.length>0&&!Ia.room.currentAction){var i=this.arr[0][0],e=null;if(Ia.options.animations?e=$e[i]:(e=qe[i],e||(e=$e[i])),e){var a=new e(this.arr[0]);Ia.room.currentAction=a}this.arr.splice(0,1)}}}function le(t){this.sprite=xi(Ze+"spr_message_bar.png"),this.text=t,this.textObj={text:this.text,size:17,bold:!0,valign:"middle",halign:"left",simpleShadow:!0,simpleShadowOffset:ne(1,1),pos:ne(0,0)},this.textWidth=Di(this.textObj),this.textLength=0,this.update=function(t){var i=40;this.textLength+=t*i,this.textLength>this.text.length&&(this.textLength=this.text.length)},this.draw=function(){Si(this.sprite,{x:aa.width/2-this.sprite.width/2,y:0}),Ia.options.animations?this.textObj.text=this.text.slice(0,this.textLength):this.textObj.text=this.text,this.textObj.pos=ne(aa.width/2-this.textWidth/2,this.sprite.height/2-4),Bi(this.textObj)}}function ce(){this.loaded=!1,this.fadedIn=!1,this.alpha=[0,0],this.venueId=!1,this.position=ne(0,22),this.screenShakes={},this.nextShakeId=1,this.damageScreenFlash=0,this.actors={arr:[],update:function(t){for(var i in this.arr){var e=this.arr[i];e.update&&e.update(t)}},draw:function(t){t||(t={}),Ia.options.animations?this.arr.sort(function(t,i){return t.position.y-i.position.y}):this.arr.sort(function(t,i){return t.origin.y-i.origin.y});for(var i in this.arr){var e=this.arr[i];e.drawShadow()}for(var i in this.arr){var e=this.arr[i];e.draw&&(t.beforeActor&&t.beforeActor(e),e.draw(),e.drawBubbles(),t.afterActor&&t.afterActor(e))}t.afterAllActors&&t.afterAllActors()},push:function(t){this.arr.push(t)}},this.getNightRatio=function(){var t=new Date,i=60*t.getHours()+t.getMinutes(),e=330,a=390,n=1110,s=1170;return e>i?1:i>=e&&a>i?qi(i,e,a,1,0):i>=a&&n>i?0:i>=n&&s>i?qi(i,n,s,0,1):1},this.initialize=function(){if(this.venueId){this.parallaxFunction=null,"boreal_wood"==this.venueId&&(this.parallaxFunction=Fi),"scorched_forest"==this.venueId&&(this.parallaxFunction=Ni),"kelp_beds"==this.venueId&&(this.parallaxFunction=Ii),"thunderhead_savanna"==this.venueId&&(this.parallaxFunction=Mi);var t="/content/battle/images/",i=[t+"venues/"+this.venueId+"/_back_day.png",t+"venues/"+this.venueId+"/_back_night.png",t+"venues/"+this.venueId+"/_fore_day.png",t+"venues/"+this.venueId+"/_fore_night.png",t+"venues/"+this.venueId+"/_parallax_1.png",t+"venues/"+this.venueId+"/_parallax_2.png",t+"strip4_battle_border.png"],e=!0;for(var a in i){var n=xi(i[a]);n.loaded||(e=!1)}if(e){this.backDay=xi(i[0]),this.backNight=xi(i[1]),this.foreDay=xi(i[2]),this.foreNight=xi(i[3]),this.parallax1=xi(i[4]),this.parallax2=xi(i[5]),this.corners=xi(i[6]);var s=this.getNightRatio();this.backNight.alpha=s,this.foreNight.alpha=s,s>=1&&(this.backDay.alpha=0,this.foreDay.alpha=0)}this.loaded=e}},this.fadeIn=function(t){if(!Ia.options.animations)return this.alpha=[1,1],void(this.fadedIn=!0);if(this.turns.initialized){var i=4;this.alpha[0]+=t*i,this.alpha[0]>=1&&(this.alpha[0]=1,this.alpha[1]+=t*i/2,this.alpha[1]>=1&&(this.alpha[1]=1,this.fadedIn=!0))}},this.turns={initialized:!1,mod:0,turnOrder:[],arrow:xi(Ze+"battleui/ui_turns_arrow.png"),initialize:function(){this.turnOrder.length&&(this.sprite=xi(Ze+"battleui/ui_turns_bar.png"),this.initialized=!0)},update:function(t){if(!this.initialized)return void this.initialize();if(!Ia.options.animations)return void(this.mod=0);var i=100*t;this.mod-i>0?this.mod-=i:this.mod=0},draw:function(){if(this.initialized){this.pos=Ia.room.stage.position.copy().add(ne(10,10)),Si(this.sprite,{pos:this.pos});var t=0,i=0,e=this.pos.x,a=this.pos.y+4,n=40,s=40,r=this.sprite.frameWidth/2-n/2,o=this.mod;for(var h in this.turnOrder){var l=zi(this.turnOrder[h]),c=1.3,d=1;if(t>3){var p=(40-o)/40;d=p,c*=p}Si(l.sprite,{x:e+r+n/2-n*c/2,y:a+i+o,width:n*c,height:s*c,alpha:d}),t++,i+=s*c-1.2*c,n=30,s=30,r=this.sprite.frameWidth/2-n/2}0==this.mod&&Si(this.arrow,{pos:this.pos.add(ne(54,14))})}}},this.firstTurn=!0,this.updateTurns=function(t){this.firstTurn?this.firstTurn=!1:this.turns.mod=40,this.turns.turnOrder=t},this.update=function(t){return this.loaded?(Ia.options.weather&&this.parallaxFunction&&this.parallaxFunction(t,ga),this.turns.update(t),Ia.room.currentAction&&Ia.room.currentAction.update(t),this.fadedIn?void this.actors.update(t):void this.fadeIn(t)):void this.initialize()},this.flashScreen=function(){this.damageScreenFlash=2},this.addScreenShake=function(t){0>=t&&(t=0);var i=this.nextShakeId;return this.nextShakeId++,this.screenShakes[i]=t,i},this.updateScreenShake=function(t,i){0>=i&&(i=0),void 0!==this.screenShakes[t]&&(this.screenShakes[t]=i)},this.removeScreenShake=function(t){delete this.screenShakes[t]},this.draw=function(){if(this.loaded){var t=na.globalAlpha;na.globalAlpha=ee(this.alpha[1]);var i=[-2,-1,0,1,2],e=0;if(Ia.options.flashes){Ia.room.currentAction&&Ia.room.currentAction.screenShaking&&(e=Ia.room.currentAction.screenShaking);for(var a in this.screenShakes)e=Math.max(e,this.screenShakes[a])}var n=ne(Math.round(e*Wi(i)),Math.round(e*Wi(i))),s=this.position.x,r=this.position.y,o=na.getXform();e&&(na.save(),na.rect(s,r,this.backDay.width,this.backDay.height),na.clip(),Si(this.backDay,{x:s,y:r}),Si(this.backNight,{x:s,y:r}),na.setXform(te(na.getXform(),Qi(n.x,n.y)))),Si(this.backDay,{x:s,y:r}),Si(this.backNight,{x:s,y:r}),Ia.options.weather&&this.parallaxFunction&&"thunderhead_savanna"==this.venueId&&ki(this),Ia.room.currentAction?Ia.room.currentAction.draw():this.actors.draw(),window.frSkipForeground||(Si(this.foreDay,{x:s,y:r}),Si(this.foreNight,{x:s,y:r})),e&&(na.restore(),na.setXform(o)),Ia.options.weather&&this.parallaxFunction&&"thunderhead_savanna"!=this.venueId&&ki(this),this.damageScreenFlash>0&&(Ia.options.flashes&&Oi({pos:ne(s,r),width:this.backDay.width,height:this.backDay.height}),this.damageScreenFlash--),na.globalAlpha=ee(this.alpha[0]),this.turns.draw();var h=this.backDay.width,l=this.backDay.height,c=this.corners.height,d=Ri(0,0,0,ee(this.alpha[0]));ji(d),_i([s+c,r],[s+h-c,r]),_i([s+c,r+l-1],[s+h-c,r+l-1]),_i([s,r+c],[s,r+l-c]),_i([s+h-1,r+c],[s+h-1,r+l-c]);var p=this.backDay.width,u=this.backDay.height,f=this.corners.height;Si(this.corners,{frame:0,x:s,y:r}),Si(this.corners,{frame:1,x:s+p-f,y:r}),Si(this.corners,{frame:2,x:s,y:r+u-f}),Si(this.corners,{frame:3,x:s+p-f,y:r+u-f}),Ia.room.currentAction&&Ia.room.currentAction.message&&Ia.room.currentAction.message.draw(),na.globalAlpha=t}}}function de(t){this.caster=t.caster,this.target=t.target,this.instanceId=t.instanceId,this.iconName=t.icon,this.icon=xi(Ze+"conditions/"+t.icon+".png"),this.name=t.name,this.desc=t.desc,this.turns=t.turns;for(var i in this.target.conditions){var e=this.target.conditions[i];e.instanceId==this.instanceId&&this.target.conditions.splice(this.target.conditions.indexOf(e),1)}this.target.conditions.push(this)}function pe(){this.condId=-1,this.show=function(t,i,e,a){this.condId!=t&&(this.condId=t,$("#coli_condition_tooltip_name").text(e),$("#coli_condition_tooltip_desc").text(a),$("#coli_condition_tooltip_icon").attr("src","/content/battle/images/conditions/"+i+".png"),$("#coli_condition_tooltip").show())},this.hide=function(t){t==this.condId&&($("#coli_condition_tooltip").hide(),this.condId=-1)}}function ue(){this.items=[],this.setInventory=function(t){this.items=[];for(var i in t){var e=t[i],a=this.items.length,n=a%4,s=Math.floor(a/4),r=null;a<Ia.consumableBinds.length&&(r=Ia.consumableBinds[a]),this.items.push(new fe({itemid:e[0],abilityId:e[1],quantity:e[2],pos:ne(440+50*n,445+50*s),keyBind:r}))}},this.update=function(t){for(var i in this.items)this.items[i].update()},this.draw=function(){for(var t in this.items)this.items[t].draw()}}function fe(t){this.itemid=t.itemid,this.abilityId=t.abilityId,this.quantity=t.quantity,this.sprite=xi("/images/cms/battle_items/"+this.itemid+".png"),this.pos=t.pos,this.cursor="pointer",this.keyBind=t.keyBind,this.update=function(t){var i=mi(this,{width:50,height:50});i==this?Ia.tooltip.showTip(this.itemid,"battle_items",ne(213,196)):Ia.tooltip.tipID==this.itemid&&Ia.tooltip.hideTip()},this.leftClick=function(t){var i=zi(Ia.room.stage.turns.turnOrder[0]);Ia.room.actionPanel.enterTargeting(i,this.abilityId,da.FRIENDLY)},this.draw=function(){Si(this.sprite,{pos:this.pos,width:50,height:50}),Bi({text:this.quantity,pos:this.pos.add(46,47),bold:!0,italic:!0,size:14,family:"Verdana",halign:"right",valign:"bottom",color:"white",simpleShadow:!0,simpleShadowOffset:ne(1,1)}),this.keyBind&&this.keyBind.draw(this.pos.x+10,this.pos.y-5)}}function me(t){t||(t={}),t.target&&(this.target=t.target);var i=t.amount||0,e=t.heal||!1,a=t.critical||!1,n=t.magic||!1,s=t.breath||!1,r=t.clash||0,o=t.pos||t.position||ne(350,200);this.hitType=t.critical,this.amount=i;var h=0;this.magic;var l="damage";r==ca.WEAK?l="grey":r==ca.STRONG&&(Ia.room.stage.flashScreen(),h=Ia.room.stage.addScreenShake(1)),s&&(l="breath",e||(l="breathDmg")),!s&&e&&(l="heal"),n&&(l="magic"),0==i?this.sprite=xi(Ze+"1px_trans.png"):this.sprite=xi(Ze+"strip10_"+l+"Numbers.png"),this.target&&(o=t.target.origin.add(t.target.sprite.frameWidth/2,t.target.sprite.height/2).add(-this.sprite.frameWidth/4,-this.sprite.height/2),e||s?s?e?this.target.modBreath(i):this.target.modBreath(-i):e&&this.target.modHealth(i):this.target.modHealth(-i)),this.pos=o,this.origin=o.copy(),this.alpha=1,this.jump=.2,this.time=.3,a==la.CRIT&&(this.critical=!0),this.amountString=i.toString(),e?this.update=function(t){this.width=this.sprite.frameWidth*this.amountString.length,this.pos.y-=64*t,this.time-=t,this.time<0&&(this.alpha-=6*t),this.alpha<0&&this.removeSelf()}:this.update=function(t){this.width=this.sprite.frameWidth*this.amountString.length,this.jump-t<0?this.time-=t:(this.jump-=t,this.pos.y-=100*(this.jump-.1)*t/.01666),this.time<0&&(this.alpha-=6*t),h&&Ia.room.stage.updateScreenShake(h,this.alpha),this.alpha<0&&this.removeSelf(),this.critical&&(this.critShake=ne(Wi([-2,-1,0,1,2]),Wi([-2,-1,0,1,2])))},this.removeSelf=function(){h&&Ia.room.stage.removeScreenShake(h),Ia.objects.remove(this)},this.draw=function(){var t=this.pos;if(0==this.amount){Ia.options.animations||(t=this.origin);var i="";return this.hitType==la.DODGE?i="Dodge!":this.hitType==la.MISS&&(i="Miss!"),void(""!=i&&Bi({text:i,pos:t,size:12,bold:!0,color:"white",halign:"center",valign:"middle",family:"Verdana",simpleShadow:!0,simpleShadowOffset:ne(1,1),alpha:this.alpha}))}if(this.critical){var e=xi(Ze+"spr_criticalHit.png");t=t.add(this.critShake)}if(Ia.options.animations||(t=this.origin),this.critical){var a=-(e.width/2)-10,n=-38;Si(e,{pos:t.add(a,n),alpha:this.alpha})}for(var s in this.amountString){var r=parseInt(this.amountString[s]),o=parseInt(s);Si(this.sprite,{pos:t.add(-this.width/2+this.sprite.frameWidth*o,0),frame:r,alpha:this.alpha})}},Ia.objects.add(this)}function ge(t,i,e){this.baseMovementSpeed=ka.baseMovementSpeed,this.frameSpeed=ka.frameSpeed,this.jumpHeightModifier=ka.jumpHeightModifier,this.selectionShadowColor="lime";var a=t[1],n=Math.ceil((a+1)/100);this.id=t[1],this.name=t[2],this.sprite=xi("/rendern/coliseum/battlesprites/"+n+"/"+a+".png"),this.portrait=xi("/rendern/coliseum/portraits/"+n+"/"+a+".png"),this.exp=t[3],e?(this.origin=ne(450+50*i,70+75*i),this.position=this.origin.copy().add(ne(300))):(this.origin=ne(125-50*i,70+75*i),this.position=this.origin.copy().add(ne(-300))),this.destination=this.position.copy(),this.selectionShadow=!1,this.movementSpeed=this.baseMovementSpeed,this.onArrival=!1,this.level=t[9],this.health={max:t[8][1],current:t[8][0]},this.breath={max:120,current:t[8][2]},this.abilities=[new re(t[5][0],0),new re(t[5][1],1),new re(t[5][2],2),new re(t[5][3],3),new re(t[5][4],4)],this.floating=t[6],this.element=t[7],this.floatDir=0,this.breed=t[11],this.instanceId=t[0],this.jumpTo=ka.jumpTo,this.moving=!1,this.moveTo=ka.moveTo,this.snapTo=ka.snapTo,this.update=ka.update,this.draw=ka.draw,this.recoil=ka.recoil,this.dodge=ka.dodge,this.modHealth=ka.modHealth,this.modBreath=ka.modBreath,this.alive=this.health.current>0,this.die=ka.die,this.elevation=0,this.alpha=1,this.alive||(this.alpha=0),this.drawShadow=ka.drawShadow,this.conditions=[],e&&(this.unitFrame=new ve(this)),this.scale=ne(1,1),this.additionalElevation=0,this.alphaMultiplier=1,this.bubbles=ka.initBubbles(),this.drawBubbles=ka.drawBubbles,this.isSilenced=ka.isSilenced,this.defeatSprite=xi("/images/cms/breeds/"+this.breed+"/coli_defeated.png")}function we(t){this.baseMovementSpeed=ka.baseMovementSpeed,this.frameSpeed=ka.frameSpeed,this.jumpHeightModifier=ka.jumpHeightModifier,this.selectionShadowColor="red",this.id=t[2],this.instanceId=t[0],this.origin=ne(t[1][0],t[1][1]),this.position=this.origin.copy().add(ne(300)),this.destination=this.origin.copy(),this.name=t[3],this.sprite=xi("/images/cms/enemies/sprites/"+t[2]+".png"),this.element=t[6],this.level=t[7],this.health={max:t[8],current:t[8],percentage:1},this.breath={max:120,current:t[9],percentage:0},this.floating=t[10],this.floatDir=0,this.highShadow=t[11],this.frame=Math.random()*t[4],this.moving=!1,this.selectionShadow=!1,this.jumpTo=ka.jumpTo,this.moveTo=ka.moveTo,this.snapTo=ka.snapTo,this.update=ka.update,this.onArrival=!1,this.modHealth=ka.modHealth,this.modBreath=ka.modBreath,this.draw=ka.draw,this.recoil=ka.recoil,this.dodge=ka.dodge,this.drawShadow=ka.drawShadow,this.drawUnitFrame=ka.drawUnitFrame,this.alive=!0,this.die=ka.die,this.conditions=[],this.elevation=0,this.alpha=1,this.movementSpeed=this.baseMovementSpeed,this.unitFrame=new ve(this),this.scale=ne(1,1),this.additionalElevation=0,this.alphaMultiplier=1,this.bubbles=ka.initBubbles(),this.drawBubbles=ka.drawBubbles,this.isSilenced=ka.isSilenced}function ve(t){this.subject=t,this.rollHealth=this.subject.health.current/this.subject.health.max,this.rollBreath=this.subject.breath.current/this.subject.breath.max,this.update=function(t){var i=this.subject.health.current/this.subject.health.max,e=this.subject.breath.current/this.subject.breath.max,a=t;this.rollHealth=Yi(this.rollHealth,i,a),this.rollBreath=Yi(this.rollBreath,e,a)},this.offscreenCanvas=null,this.offscreenPainted=!1,this.width=-1,this.height=45,this.draw=function(){if(!(window.frSkipUnitPanels||this.subject.alpha<=0)){var t=this.subject.name;this.width<0&&(this.width=Di({text:t,family:"Verdana",bold:!0,size:9}),this.width+=5,this.width=Math.max(this.width,85),this.offscreenCanvas=new Ee(this.width,this.height));var i=xi(Ze+"strip5_enemyUnitFrame.png"),e=xi(Ze+"strip12_enemyElementIcon.png");if(!this.offscreenPainted&&this.offscreenCanvas&&i.loaded&&e.loaded&&(this.offscreenCanvas.drawOffscreen(function(){var a=ne(this.width,15);Bi({text:t,pos:a.add(-1,0),family:"Verdana",bold:!0,size:9,simpleShadow:!0,simpleShadowOffset:ne(1,1),color:"white",halign:"right",valign:"bottom"}),Si(e,{frame:this.subject.element,pos:a.add(-84,0)}),Si(i,{frame:0,pos:a.add(-56,2)}),Si(i,{frame:2,pos:a.add(-56,16)})},this),this.offscreenPainted=!0),this.offscreenPainted){var a=this.subject.elevation,n=this.subject.position;Ia.options.animations||(a=0,n=this.subject.origin);var s=n.add(83,-32);s.y<Ia.room.stage.position.y+20&&(s.y=Ia.room.stage.position.y+20),s.x=Ui(s.x),s.y=Ui(s.y);var r=this.rollHealth,o=this.rollBreath;Ia.options.animations||(r=this.subject.health.current/this.subject.health.max,o=this.subject.breath.current/this.subject.breath.max);var h=na.globalAlpha;na.globalAlpha=this.subject.alpha,na.drawImage(this.offscreenCanvas.canvas,s.x-this.width+1,s.y-15),na.globalAlpha=h,Si(i,{frame:1,pos:s.add(-55,2),percent:r,alpha:this.subject.alpha}),ia?Si(i,{frame:3,pos:s.add(-55,16),percent:o,alpha:this.subject.alpha}):Si(i,{frame:4,pos:s.add(-55,16),alpha:this.subject.alpha});for(var l in this.subject.conditions){var c=this.subject.conditions[l];Si(c.icon,{pos:s.add(-17-parseInt(l)*c.icon.frameWidth-1,27),alpha:this.subject.alpha})}}}}}function be(t){this.sprite=xi(Ze+"battleui/party_change.png"),this.pos=ne(),this.button={pos:ne(),relativePos:ne(120,120),update:function(t){mi(this,{width:80,height:40})},leftClick:function(){coliseumSelect("mainMenu")},cursor:"pointer"},this.alpha=0,this.update=function(t){this.pos=ne(aa.width/2-this.sprite.width/2,aa.height/2-this.sprite.height/2),this.button.pos=this.pos.add(this.button.relativePos),this.alpha+=3*t,this.button.update(t)},this.draw=function(){Si(this.sprite,{pos:this.pos,alpha:this.alpha})}}function ye(t,i,e,a){this.width=Math.abs(t-e),this.height=Math.abs(i-a),this.frames=1}function Ae(){this.sprite=xi(Ze+"strip2_flee.png"),this.pos=ne(109,39),this.fled=!1,this.confirm={pos:this.pos.add(ne(248,291)),leftClick:function(){this.fled||(Hi("flee"),this.fled=!0)},cursor:"pointer"},this.cancel={pos:this.pos.add(ne(87,291)),leftClick:function(){this.fled||(Ia.room.modal=!1)},cursor:"pointer"},this.update=function(t){var i={width:149,height:91};mi(this.cancel,i),mi(this.confirm,i)},this.draw=function(){Si(this.sprite,{pos:this.pos,frame:0})}}function xe(t){this.lastms=null,this.tweaks={timescale:1},this.connectionManager=null,this.conditionTooltip=null,window.requestAnimationFrame=window.requestAnimationFrame||window.mozRequestAnimationFrame||window.webkitRequestAnimationFrame||window.oRequestAnimationFrame,window.performance&&window.performance.now?this.getTimestamp=function(){return window.performance.now()}:this.getTimestamp=function(){return newDate().getTime()},this.hideAllTooltips=function(){this.conditionTooltip&&this.conditionTooltip.hide(),this.tooltip&&this.tooltip.hideTip()},this.computeDelta=function(t){if(null==this.lastms)return this.lastms=t,0;var i=.001*(t-this.lastms);return this.lastms=t,i*=this.tweaks.timescale,0>i?0:i>.1?.1:i},this.perfCounter=new Te,this.firstStep=!0,this.step=function(t){this.firstStep&&(this.firstStep=!1);var i=this.computeDelta(t);try{this.perfCounter.beginFrame(),this.update(i),this.perfCounter.pushRegion(Sa.RENDER),this.render(),this.perfCounter.popRegion(Sa.RENDER),this.perfCounter.pushRegion(Sa.DEBUG),this.perfCounter.render(),this.perfCounter.popRegion(Sa.DEBUG),this.perfCounter.endFrame()}catch(e){throw Ue&&Ue(Da.MAIN_LOOP_CRASH,e),e}finally{window.requestAnimationFrame(this.pStep)}};var i=this;this.pStep=function(t){i.step(t)},this.room=t||{},this.objects=new Se,this.lastFullscreenState=null,this.cssCheckCycle=0,this.update=function(t){this.mouseoverRects.clearMouseoverRects();var i=0==this.cssCheckCycle;this.cssCheckCycle=(this.cssCheckCycle+1)%30,i&&$("#pl_content").height($("#cnv").height()+$("#controlPanel").height());var e=this.isFullscreen();if(this.lastFullscreenState!==e||i){if(e){var a=1;a=window.innerWidth>=window.innerHeight?window.innerHeight/$("#pl_content").height():window.innerWidth/$("#pl_content").width(),$("#pl_content").css({transform:"scale("+a+")"}),$("#pl_content").css({left:.5*window.innerWidth-.5*$("#pl_content").width()}),$("#pl_content").css({top:.5*window.innerHeight-.5*$("#pl_content").height()}),$("#pl_content").css({top:.5*window.innerHeight-.5*$("#pl_content").height()}),$("#pl_content").css({"margin-left":"0"}),$("#pl_content").addClass("fullscreen"),$("#pl_fullscreenContainer").addClass("fullscreen"),$("body").addClass("fullscreen"),window.scrollTo(0,0)}else $("#pl_content").css({transform:""}),$("#pl_content").css({left:""}),$("#pl_content").css({top:""}),$("#pl_content").css({"margin-left":""}),$("#pl_content").removeClass("fullscreen"),$("body").removeClass("fullscreen"),$("#pl_fullscreenContainer").removeClass("fullscreen");this.lastFullscreenState=e}this.room&&this.room.update&&this.room.update(t),this.objects.update(t),this.whiteAlpha>0&&(this.whiteAlpha-=1.5*t),this.perfCounter.update(t)},this.renderInit=!1,this.whiteAlpha=1,this.globalActionDeltaMultiplier=1,this.render=function(){if(!this.renderInit){var t=700,i=632;return aa.width=t,aa.height=i,aa.style.width=t+"px",aa.style.height=i+"px",void(this.renderInit=!0)}if(na.setXform(Ki()),na.clearRect(0,0,aa.width,aa.height),this.room&&this.room.draw&&this.room.draw(),this.objects.draw(),this.whiteAlpha>0&&this.options.animations){na.globalAlpha=this.whiteAlpha,na.fillStyle="white",na.fillRect(0,0,25,aa.height);var e=document.getElementById("internal_bg");na.fillRect(25,e.height-82,aa.width,aa.height),na.drawImage(e,25,-82),na.globalAlpha=1}},this.run=function(){window.requestAnimationFrame(this.pStep)},this.requestFullscreen=function(){var t=document.getElementById("pl_fullscreenContainer");t.requestFullscreen?t.requestFullscreen():t.webkitRequestFullscreen?t.webkitRequestFullscreen():t.msRequestFullscreen?t.msRequestFullscreen():t.mozRequestFullScreen&&t.mozRequestFullScreen()},this.exitFullscreen=function(){document.exitFullscreen?document.exitFullscreen():document.webkitExitFullscreen?document.webkitExitFullscreen():document.msExitFullscreen?document.msExitFullscreen():document.mozCancelFullScreen&&document.mozCancelFullScreen()},this.isFullscreen=function(){return document.fullscreenElement||document.webkitFullscreenElement||document.msFullscreenElement||document.mozFullScreenElement?!0:!1},this.toggleFullscreen=function(){this.isFullscreen()?this.exitFullscreen():this.requestFullscreen()}}function Se(){this.arr=[],this.update=function(t){for(var i in this.arr)this.arr[i].update&&this.arr[i].update(t)},this.draw=function(){this.arr.sort(function(t,i){return void 0==t.depth&&(t.depth=0),void 0==i.depth&&(i.depth=0),i.depth-t.depth});for(var t in this.arr)this.arr[t].draw&&this.arr[t].draw()},this.add=function(t){this.arr.push(t)},this.remove=function(t){this.arr.indexOf(t)>-1&&this.arr.splice(this.arr.indexOf(t),1)},this.contains=function(t){return this.arr.indexOf(t)>-1?!0:!1}}function _e(t){this.keyCode=t,this.obj=null,this.sprite=xi(Ze+"keyboard/"+t+".png"),this.draw=function(t,i){Ia.controls.radio&&Si(this.sprite,{pos:{x:t,y:i}})}}function Ce(){var t=[49,50,51,52,53,54,55,81,87,69,82,84,65,83,68,70,27];this.keyBinds=[];for(var i in t)this.keyBinds[t[i]]=new _e(t[i]);this.push=function(t){if(Ia.controls.radio&&this.keyBinds[t]&&this.keyBinds[t].obj&&this.keyBinds[t].obj.leftClick){this.keyBinds[t].obj.leftClick();for(var i in this.keyBinds)this.keyBinds[i]&&(this.keyBinds[i].obj=null)}}}function ke(t,i){var e=403,a=132,n=56,s=t%4,r=Math.floor(t/4);this.itemid=i[0],this.category=i[1],this.quantity=i[2],this.pos=ne(e+5+s*(n+1),a+7+r*n),this.sprite=xi("/images/cms/"+this.category+"/"+this.itemid+".png"),this.quantityBGSprite=xi("/content/battle/images/spr_item_quantity_bg.png"),this.isMousedOver=function(){return mi(this,{width:n,height:n})==this},this.draw=function(t){if(Si(this.sprite,{alpha:t,width:n,height:n,pos:this.pos}),this.quantity>1){var i=this.pos.add(56,56).add(-11,-8);Si(this.quantityBGSprite,{alpha:t,pos:i.add(-11,-9)}),Bi({text:this.quantity,pos:i,bold:!0,size:11,family:"Verdana",halign:"center",valign:"middle",color:"#731d08",alpha:t})}}}function Ee(t,i){this.width=t,this.height=i,this.canvas=document.createElement("canvas"),this.canvas.width=t,this.canvas.height=i,this.ctx=this.canvas.getContext("2d")}function Oe(){this.sprite=xi(Ze+"pvp/ui_window_text_pvp_startqueue.png"),this.depth=-1e3,this.refused=!1,this.update=function(t){if(!this.refused&&PVPMatchFound&&(Ia.room.modal=this),Ia.room.modal==this){PVPMatchFound?this.sprite=xi(Ze+"pvp/ui_window_text_pvp_matchfound.png"):queuedForPvp?this.sprite=xi(Ze+"pvp/ui_window_text_pvp_cancelqueue.png"):this.sprite=xi(Ze+"pvp/ui_window_text_pvp_startqueue.png");var i={width:82,height:40};mi(this.cancel,i),mi(this.confirm,i)}},this.pos=ne(190,216),this.cancel={pos:this.pos.add(ne(74,122)),leftClick:function(){Ia.room.modal=!1},cursor:"pointer"},this.confirm={pos:this.pos.add(ne(171,122)),leftClick:function(){Ia.room.modal=!1,PVPMatchFound?(unqueuePVP(),coliseumSelect("finalizePVP")):queuedForPvp?unqueuePVP():unqueuePVP=queueForPVP()},cursor:"pointer"},this.draw=function(){Ia.room.modal==this&&Si(this.sprite,{pos:this.pos})},Ia.objects.add(this)}function Te(){this.hist=[],this.frameLimit=180,this.started=!1,this.periodStart=0,this.periodFrames=0,this.fps=0,this.mode=0,this.regionStack=[],this.currentRegion=null,this.currentFrame=null,this.regionStart=0,this.pos=ne(0,564),this.height=66,this.beginFrame=function(){this.regionStack=[],this.currentRegion=Sa.UPDATE,this.regionStart=Ia.getTimestamp(),this.started||(this.periodStart=this.regionStart,this.started=!0),this.currentFrame={update:0,render:0,debug:0}},this.pushRegion=function(t){var i=Ia.getTimestamp();this.regionStack.push(this.currentRegion),this.currentFrame[this.currentRegion]+=i-this.regionStart,this.regionStart=i,this.currentRegion=t},this.popRegion=function(t){var i=Ia.getTimestamp();this.currentRegion!==t,this.currentFrame[this.currentRegion]+=i-this.regionStart,this.regionStart=i,this.currentRegion=this.regionStack.pop()},this.endFrame=function(){var t=Ia.getTimestamp();this.currentFrame[this.currentRegion]+=t-this.regionStart,this.hist.push(this.currentFrame),this.currentFrame=null,this.hist.length>this.frameLimit&&this.hist.splice(0,1),this.periodFrames++,t-this.periodStart>=1e3&&(this.fps=Math.round(this.periodFrames/(.001*(t-this.periodStart))),this.periodFrames=0,this.periodStart=t)};var t=this;this.mouseoverObj={pos:this.pos,area:{width:this.frameLimit,height:66},cursor:"pointer",leftClick:function(){t.toggleDetail()}},this.update=function(t){mi(this.mouseoverObj,this.mouseoverObj.area)},this.toggleDetail=function(){this.mode=(this.mode+1)%3},this.render=function(){if(0!=this.mode){var t=this.pos.y+this.height,i=this.pos.x,e=2;if(2==this.mode){var a=i;a+=this.frameLimit-this.hist.length;var n;n=a+.5,ji(0,128,255),na.beginPath();for(var s=0;s<this.hist.length;++s,++n){var r=this.hist[s],o=t,h=o-r.update*e;na.moveTo(n,o),na.lineTo(n,h),r.y=h}na.stroke(),n=a,ji(255,128,0),na.beginPath();for(var s=0;s<this.hist.length;++s,++n){var r=this.hist[s],o=r.y,h=o-r.render*e;na.moveTo(n,o),na.lineTo(n,h),r.y=h}na.stroke(),n=a,ji(0,0,0),na.beginPath();for(var s=0;s<this.hist.length;++s,++n){var r=this.hist[s],o=r.y,h=o-r.debug*e;na.moveTo(n,o),na.lineTo(n,h),r.y=h}na.stroke(),ji(255,0,0),_i([i,t-16.666*e],[i+this.frameLimit,t-16.666*e])}var l=14;if(textObj={text:"FPS "+this.fps,size:l,valign:"left",halign:"left",bold:!0,color:"black",pos:ne(i+2,t-50)},2==this.mode&&(l=12,textObj.size=l,textObj.pos=ne(i+2,this.pos.y+2)),Bi(textObj),Ia.connectionManager){var c=Ia.connectionManager,d=c.getSimpleState(),p="";if(d===Ba.CONNECTING)p="Connecting...";else if(d==Ba.CONNECTED){var u=c.getPing();p=0>u?"Ping ?":"Ping "+u,p+=" ("+c.getTransportName()+")"}else d==Ba.DISCONNECTED&&(p="Disconnected");textObj.pos.y+=l,textObj.text=p,Bi(textObj)}}}}function Be(){this.party=[]}function De(){return this.initialize=function(){this.panels=[];var t=0,i=Ia.room.stage.actors.arr;for(var e in i){var a=i[e];a.playerControlled&&(this.panels.push(new Pe(a,ne(15,390+57*t))),t++)}},this.update=function(t){for(var i in this.panels)this.panels[i].update(t)},this.draw=function(){for(var t in this.panels)this.panels[t].draw()},this}function Pe(t,i){this.width=400,this.height=50,this.offscreenCanvas=new Ee(this.width,2*this.height),this.pos=i,this.subject=t,this.color=We(this.subject.element).color,this.border=xi(Ze+"spr_portrait_border.png"),this.portrait=this.subject.portrait,this.ready=xi(Ze+"strip2_ready.png"),this.levelBoxSprite=xi(Ze+"spr_level_box.png"),this.offscreenPainted=!1,this.nameTextWidth=0;var e=this.pos;this.healthBar={subject:t,pos:e.add(ne(98,17)),tooltip:{active:!1,subject:t,textObj:{size:14,bold:!0,simpleShadow:!0,simpleShadowOffset:ne(1,1),family:"Courier",halign:"right"},draw:function(){this.textObj.text=this.subject.health.current+"/"+this.subject.health.max;var t={color:"rgba(0, 0, 0, 0.5)",pos:this.pos.add(ne(-4,-4)),width:Di(this.textObj)+8,height:36};Oi(t),t.color="white",t.filled=!1,t.shadow=!0,Oi(t),this.textObj.color="lime",this.textObj.pos=this.pos.add(ne(t.width-8,0)),Bi(this.textObj),this.textObj.color="aqua",this.textObj.text=this.subject.breath.current+"/"+this.subject.breath.max,this.textObj.pos=this.pos.add(ne(t.width-8,13)),Bi(this.textObj)}},sprite:xi(Ze+"strip4_health_bars.png"),rollHealth:this.subject.health.current/this.subject.health.max,rollBreath:this.subject.breath.current/this.subject.breath.max,update:function(t){var i=this.subject.health.current/this.subject.health.max,e=this.subject.breath.current/this.subject.breath.max,a=t;this.rollHealth=Yi(this.rollHealth,i,a),this.rollBreath=Yi(this.rollBreath,e,a);var n=mi(this);n==this?(this.tooltip.active=!0,this.tooltip.pos=this.pos.add(ne(-89,-8))):this.tooltip.active&&(this.tooltip.active=!1)},drawStatic:function(t){this.sprite.frameWidth;Si(this.sprite,{frame:0,pos:t}),Si(this.sprite,{frame:2,pos:t})},drawDynamic:function(){var t=(this.sprite.frameWidth,this.rollHealth),i=this.rollBreath;Ia.options.animations||(t=this.subject.health.current/this.subject.health.max,i=this.subject.breath.current/this.subject.breath.max),Si(this.sprite,{frame:1,pos:this.pos,percent:t}),Si(this.sprite,{frame:3,pos:this.pos,percent:i}),this.tooltip.active&&this.tooltip.draw()}},this.update=function(t){this.healthBar.update(t);var i=this.getConditionLayout();for(var e in i){var a=i[e].condition,n={pos:i[e].pos},s={width:a.icon.frameWidth,height:a.icon.height};mi(n,s)==n?Ia.conditionTooltip.show(a.instanceId,a.iconName,a.name,a.desc):Ia.conditionTooltip.hide(a.instanceId)}},this.draw=function(){if(!window.frSkipUnitPanels){!this.offscreenPainted&&this.portrait.loaded&&this.border.loaded&&this.ready.loaded&&this.levelBoxSprite.loaded&&this.healthBar.sprite.loaded&&(this.offscreenCanvas.drawOffscreen(function(){for(var t=0;2>t;++t){var i=t*this.height;Oi({pos:ne(0,i),color:this.color,width:this.border.width-35,height:this.border.height-1});var e=1==t;e?this.portrait.alpha=1:this.portrait.alpha=.7,Si(this.portrait,{pos:ne(0,i)}),Si(this.border,{pos:ne(0,i)}),Si(this.ready,{pos:ne(319,i),frame:e}),Si(this.levelBoxSprite,{pos:ne(1,i+26)});var a={text:"Lv. "+this.subject.level,pos:ne(27,i+36),size:12,bold:!0,color:"white",halign:"center",
valign:"middle",simpleShadow:!0,simpleShadowOffset:ne(1,1),family:"Verdana"};Bi(a),this.healthBar.drawStatic(ne(98,i+17));var n={text:this.subject.name,pos:ne(300,i+2),size:12,bold:!0,color:"#731d08",halign:"right",valign:"top",family:"Verdana"};this.nameTextWidth<=0&&(this.nameTextWidth=Di(n)),Bi(n)}},this),this.offscreenPainted=!0);var t=Ia.room.nextActor==this.subject&&!Ia.room.currentAction&&!Ia.room.battleEnded;if(this.offscreenPainted){var i=t?this.height:0;na.drawImage(this.offscreenCanvas.canvas,0,i,this.width,this.height,this.pos.x,this.pos.y,this.width,this.height)}this.healthBar.drawDynamic();var e=this.getConditionLayout();for(var a in e)Si(e[a].condition.icon,{pos:e[a].pos})}},this.getConditionLayout=function(){var t=[],i=300-this.nameTextWidth-4;for(var e in this.subject.conditions){var a=this.subject.conditions[e];a.icon.loaded&&(t.push({condition:a,pos:this.pos.add(i-a.icon.frameWidth,17-a.icon.height-1)}),i-=a.icon.frameWidth)}return t}}function Ie(t){var i=1;for(var e in t)i=Math.max(i,t[e].level);return i}function Ne(t,i){for(var e=Ie(i),a=1;e>a&&t>=i[a].maxXP;)a++;return a}function Me(t,i,e){this.index=t,this.battleLevels=e,this.did=i[0],this.dragonName=i[1],this.xpBefore=i[2],this.xpAfter=i[3],this.xpCurrent=this.xpBefore,this.levelBefore=Ne(this.xpBefore,this.battleLevels),this.levelAfter=Ne(this.xpAfter,this.battleLevels),this.levelCurrent=this.levelBefore,this.stoneSlotUnlocked=i[4],this.xpBarRoll=0,this.portraitFrameSprite=xi("/content/battle/images/spr_portrait_frame.png");var a=Math.ceil((this.did+1)/100);this.portraitSprite=xi("/rendern/portraits/"+a+"/"+this.did+"p.png"),this.xpBarSprite=xi("/content/battle/images/strip2_win_xp_bar_shortened.png"),this.levelUpToastSprite=xi("/content/battle/images/spr_level_up.png"),this.stoneSlotUnlockedSprite=xi("/content/battle/images/spr_stone_unlocked.png"),this.toasts=[],this.rowHeight=82,this.stoneUnlockTime=0,this.stoneAlpha=0;var n=this;this.stoneMouseObject={pos:ne(58,128+this.rowHeight*this.index),area:{width:78,height:78},cursor:"pointer",leftClick:function(){coliseumSelect("equipSelect",n.did)}},this.update=function(t){this.xpBarRoll+=t/1.5,this.xpBarRoll>=1&&(this.xpBarRoll=1);var i=this.levelCurrent;for(var e in this.toasts)this.toasts[e].time+=t;Ia.options.animations?this.xpCurrent=Math.round(Vi(this.xpBefore,this.xpAfter,ie(this.xpBarRoll))):this.xpCurrent=this.xpAfter,this.levelCurrent=Ne(this.xpCurrent,this.battleLevels),this.levelCurrent>i&&this.spawnLevelUpToast(),this.stoneUnlockTime+=t,this.stoneSlotUnlocked?this.stoneAlpha=qi(this.stoneUnlockTime,1.25,3,0,1):this.stoneAlpha=0,this.stoneAlpha>.25&&mi(this.stoneMouseObject,this.stoneMouseObject.area)},this.spawnLevelUpToast=function(){this.toasts.push({time:0})},this.draw=function(t){var i=this.index,e=(this.did,this.rowHeight),a=58,n=129+e*i;Oi({color:Ri(255,255,255,t),pos:ne(a+1,n+1),width:75,height:75,filled:!0}),Si(this.portraitSprite,{pos:ne(a+1,n+1),alpha:t}),Si(this.portraitFrameSprite,{pos:ne(a,n),alpha:t});var s,r,o=Ie(this.battleLevels),h=this.xpCurrent,l=Ne(h,this.battleLevels),c=""+l,d=""+(l+1),p=this.battleLevels[l];l>=o?(d="",s=1,r="Max Level"):(nextLevel=l+1,s=(h-p.minXP)/(p.maxXP-p.minXP),r=h-p.minXP+"/"+(p.maxXP-p.minXP));var u,f=Ne(this.xpAfter,this.battleLevels);if(f>=o)u=1;else{var m=this.battleLevels[f];u=(this.xpAfter-m.minXP)/(m.maxXP-m.minXP)}var g=162,w=155+e*i,v=183,b=24;Si(this.xpBarSprite,{pos:ne(g,w),alpha:t,frame:0}),Si(this.xpBarSprite,{pos:ne(g,w),alpha:t,frame:1,percent:s}),Bi({text:this.dragonName,pos:ne(g,w),bold:!0,size:11,family:"Verdana",halign:"left",valign:"bottom",color:"#838075",alpha:t});var y=152,A=166+e*i,x=355,S=166+e*i;Bi({text:c,pos:ne(y,A),bold:!0,size:10,family:"Verdana",halign:"center",valign:"middle",color:"#838075",alpha:t}),Bi({text:d,pos:ne(x,S),bold:!0,size:10,family:"Verdana",halign:"center",valign:"middle",color:"#838075",alpha:t});var _=g+Math.round(.5*v),C=w+Math.round(.5*b);if(Bi({text:r,pos:ne(_,C),bold:!1,size:11,family:"Verdana",halign:"center",valign:"middle",color:"white",alpha:t,simpleShadow:!0,simpleShadowOffset:ne(1,1)}),l==f){var k=xi("/content/battle/images/spr_xp_tiny_arrow.png"),E=182+e*i,O=3;Si(k,{pos:ne(g+Math.round(v*u)-O,E),alpha:t})}this.stoneSlotUnlocked&&Si(this.stoneSlotUnlockedSprite,{pos:ne(46,119+this.index*e),alpha:t*this.stoneAlpha})},this.drawToasts=function(){for(var t in this.toasts){var i=35,e=115+this.rowHeight*this.index,a=0,n=this.toasts[t].time;Ia.options.animations?(e-=100*n,a=.25>n?qi(n,0,.25,0,1):qi(n,.25,1,1,0)):a=.5>n?qi(n,0,.5,0,1):1.5>n?1:qi(n,1.5,2,1,0),Si(this.levelUpToastSprite,{pos:ne(i,e),alpha:a})}}}function Fe(){function t(t){"string"!=typeof t&&(t.locked_out?(alert("Sorry, you must wait a while before trying to solve any more captchas."),window.location="/main.php?p=battle"):t.must_solve?i(t):($("#camp-window").hide(),socket.emit(Ke.campDone)))}function i(i){var e=i.buff,a=i.puzzle,n=(i.code,$("#camp-window")),s=n.find(".camp-buff");s.removeAttr("class"),s.addClass("camp-buff camp-buff-"+e);var r=$("<img>");r.attr("src","/image_generators/puzzle.php?id="+a);var o=n.find(".camp-puzzle");o.empty(),o.append(r);var h=n.find(".camp-calibrator"),l=!1;o.off("click"),o.on("click",function(i){if(l)return!1;l=!0;var e=$(h).offset().left,n=$(h).offset().top,s=$(this).offset().left,r=$(this).offset().top,o=300,c=180,d=Math.round((i.pageX-s)*o/(e-s)),p=Math.round((i.pageY-r)*c/(n-r));$.ajax("/content/battle/public_ajax.php",{method:"POST",dataType:"json",data:{a:"camp",x:d,y:p,id:a}}).done(function(i){t(i)}).fail(function(){})}),Ia.hideAllTooltips(),n.show()}return $.ajax("/content/battle/public_ajax.php",{method:"POST",data:{a:"camp_init"}}).done(function(i){t(i)}).fail(function(){}),{name:"campRoom",update:function(t){},draw:function(){},modal:!1}}function Re(){return{name:"battleRoom",objects:{arr:[],update:function(t){for(var i in this.arr){var e=this.arr[i];e.update&&e.update(t)}},draw:function(){for(var t in this.arr){var i=this.arr[t];i.draw&&i.draw()}},push:function(t){this.arr.push(t)}},battleEnded:!1,stage:new ce,unitFrames:new De,actionPanel:new oe,actionQueue:new he,modal:!1,currentAction:!1,update:function(t){if(this.stage.actors.arr.length){for(var i in this.stage.actors.arr){var e=this.stage.actors.arr[i];if(!e.sprite.loaded)return}0==fa&&(aa.style.cursor="default"),this.stage.update(t),this.modal?this.modal.update&&this.modal.update(t):(this.unitFrames.update(t),this.battleEnded?this.modal||this.actionQueue.length||this.currentAction||(this.modal=this.endScreen):this.actionPanel.update(t),ta=zi(Ia.room.stage.turns.turnOrder[0])),this.objects.update(t),this.actionQueue.update(t)}},draw:function(){this.stage.draw(),this.unitFrames.draw();for(var t in this.stage.actors.arr){var i=this.stage.actors.arr[t];i.playerControlled||i.unitFrame.draw()}this.actionPanel.draw(),this.objects.draw(),this.modal&&this.modal.draw&&this.modal.draw()},endBattle:function(t){this.battleEnded=!0;var i=t[0];if(i==ua.P1_FLEE)return void coliseumSelect("mainMenu");if(i==ua.P1_WIN||i==ua.P2_WIN){for(var e=t[5],a={},n=0,s=0;s<e.length;++s){var r={level:e[s][0],minXP:n,maxXP:e[s][1]};a[r.level]=r,r.xpRange=r.maxXP-r.minXP,n=r.maxXP}this.endScreen=ze({winType:t[0],exp:t[1],loot:t[2],victoryChain:t[3],xpBars:t[4],battleLevels:a})}else i==ua.P1_PARTY_CHANGED?this.endBattleWithMessage("The composition of your party has changed."):i==ua.P1_ENERGY_LOW?this.endBattleWithMessage("One or more of your dragons no longer have enough energy to continue battling."):i==ua.P1_DUPLICATE?this.endBattleWithMessage("Duplicate login detected."):this.endBattleWithMessage("Battle was terminated prematurely ("+i+")")},endBattleWithMessage:function(t){alert(t),setTimeout(function(){coliseumSelect("mainMenu")},1e3)}}}function Le(){var t=Ze+"bottomBar/",i=this;this.bottomBarTooltip=xi(Ze+"mainMenu/strip4_bottombarTooltips.png");var e=10,a=70,n=aa.width/2-2*a-e;Ia.objects.add({tooltip:0,pos:ne(n,562),cursor:"pointer",depth:-2,spriteList:{def:{inactive:xi(t+"button_pvp_inactive.png"),click:xi(t+"button_pvp_click.png"),mouseOver:xi(t+"button_pvp_mouseover.png")},found:{inactive:xi(t+"button_pvpfound_inactive.png"),click:xi(t+"button_pvpfound_click.png"),mouseOver:xi(t+"button_pvpfound_mouseover.png")},search:{inactive:xi(t+"button_pvpsearching_inactive.png"),click:xi(t+"button_pvpsearching_click.png"),mouseOver:xi(t+"button_pvpsearching_mouseover.png")},pvpTimer:xi(t+"ui_pvptimer.png")},spriteGroup:null,sprite:null,modal:new Oe,fadeAlpha:0,update:function(t){if(coliFeatureFlags.pvp){if(null==this.spriteGroup&&(this.spriteGroup=this.spriteList.def,this.sprite=this.spriteGroup.inactive),!Ia.room.modal||Ia.room.modal==this.modal)var i=mi(this,{width:this.sprite.frameWidth,height:this.sprite.height});var e=8,a=t*e;i==this?this.fadeAlpha+a<1?this.fadeAlpha+=a:this.fadeAlpha=1:this.fadeAlpha-a>0?this.fadeAlpha-=a:this.fadeAlpha=0,PVPMatchFound?this.spriteGroup=this.spriteList.found:queuedForPvp?this.spriteGroup=this.spriteList.search:this.spriteGroup=this.spriteList.def}},draw:function(){if(coliFeatureFlags.pvp){if(Si(this.spriteGroup.inactive,{pos:this.pos}),Ia.room.modal)Ia.room.modal==this.modal&&Si(this.spriteGroup.click,{pos:this.pos});else if(Ia.options.animations&&this.fadeAlpha>0){Si(this.spriteGroup.mouseOver,{pos:this.pos,alpha:this.fadeAlpha});var e=ne(-i.bottomBarTooltip.frameWidth/2+this.spriteGroup.mouseOver.frameWidth/2,-this.spriteGroup.mouseOver.height);Si(i.bottomBarTooltip,{pos:this.pos.add(e),frame:0,alpha:this.fadeAlpha})}}else Si(xi(t+"button_pvp_inactive_BETA.png"),{pos:this.pos})},leftClick:function(){coliFeatureFlags.pvp&&(Ia.room.modal==this.modal?Ia.room.modal=!1:Ia.room.modal||(Ia.room.modal=this.modal))}}),Ia.objects.add({tooltip:1,pos:ne(n+e+a,562),cursor:"pointer",depth:-2,modal:null,fadeAlpha:0,sprite:{inactive:xi(t+"button_controls_inactive.png"),click:xi(t+"button_controls_click.png"),mouseOver:xi(t+"button_controls_mouseover.png")},update:function(t){if(null==this.modal&&(this.modal=Ia.controls),!Ia.room.modal||Ia.room.modal==this.modal)var i=mi(this,{width:this.sprite.inactive.frameWidth,height:this.sprite.inactive.height});var e=8,a=t*e;i==this?this.fadeAlpha+a<1?this.fadeAlpha+=a:this.fadeAlpha=1:this.fadeAlpha-a>0?this.fadeAlpha-=a:this.fadeAlpha=0},draw:function(){if(Si(this.sprite.inactive,{pos:this.pos}),Ia.room.modal)Ia.room.modal==this.modal&&Si(this.sprite.click,{pos:this.pos});else if(Ia.options.animations&&this.fadeAlpha>0){Si(this.sprite.mouseOver,{pos:this.pos,alpha:this.fadeAlpha});var t=ne(-i.bottomBarTooltip.frameWidth/2+this.sprite.mouseOver.frameWidth/2,-this.sprite.mouseOver.height);Si(i.bottomBarTooltip,{pos:this.pos.add(t),frame:1,alpha:this.fadeAlpha})}},leftClick:function(){Ia.room.modal==this.modal?Ia.room.modal=null:(Ia.objects.contains(Ia.controls)||Ia.objects.add(Ia.controls),Ia.room.modal=this.modal)}}),Ia.objects.add({tooltip:2,pos:ne(n+2*e+2*a,562),cursor:"pointer",depth:-2,sprite:{inactive:xi(t+"button_options_inactive.png"),click:xi(t+"button_options_click.png"),mouseOver:xi(t+"button_options_mouseover.png")},modal:null,fadeAlpha:0,update:function(t){if(null==this.modal&&(this.modal=Ia.options),!Ia.room.modal||Ia.room.modal==this.modal)var i=mi(this,{width:this.sprite.inactive.frameWidth,height:this.sprite.inactive.height});var e=8,a=t*e;i==this?this.fadeAlpha+a<1?this.fadeAlpha+=a:this.fadeAlpha=1:this.fadeAlpha-a>0?this.fadeAlpha-=a:this.fadeAlpha=0},draw:function(){if(Si(this.sprite.inactive,{pos:this.pos}),Ia.room.modal)Ia.room.modal==this.modal&&Si(this.sprite.click,{pos:this.pos});else if(Ia.options.animations&&this.fadeAlpha>0){Si(this.sprite.mouseOver,{pos:this.pos,alpha:this.fadeAlpha});var t=ne(-i.bottomBarTooltip.frameWidth/2+this.sprite.mouseOver.frameWidth/2,-this.sprite.mouseOver.height);Si(i.bottomBarTooltip,{pos:this.pos.add(t),frame:2,alpha:this.fadeAlpha})}},leftClick:function(){Ia.options.active?Ia.options.deactivate():(Ia.objects.contains(Ia.options)||Ia.objects.add(Ia.options),Ia.options.activate())}}),Ia.objects.add({tooltip:3,pos:ne(n+3*e+3*a,562),cursor:"pointer",depth:-2,sprite:{inactive:xi(t+"button_fullscreen_inactive.png"),click:xi(t+"button_fullscreen_click.png"),mouseOver:xi(t+"button_fullscreen_mouseover.png")},modal:null,fadeAlpha:0,requireGesture:!0,update:function(t){if(!Ia.room.modal||Ia.room.modal==this.modal)var i=mi(this,{width:this.sprite.inactive.frameWidth,height:this.sprite.inactive.height});var e=8,a=t*e;i==this?this.fadeAlpha+a<1?this.fadeAlpha+=a:this.fadeAlpha=1:this.fadeAlpha-a>0?this.fadeAlpha-=a:this.fadeAlpha=0},draw:function(){if(Si(this.sprite.inactive,{pos:this.pos}),Ia.room.modal)Ia.room.modal==this.modal&&Si(this.sprite.click,{pos:this.pos});else if(Ia.options.animations&&this.fadeAlpha>0){Si(this.sprite.mouseOver,{pos:this.pos,alpha:this.fadeAlpha});var t=ne(-i.bottomBarTooltip.frameWidth/2+this.sprite.mouseOver.frameWidth/2,-this.sprite.mouseOver.height);Si(i.bottomBarTooltip,{pos:this.pos.add(t),frame:3,alpha:this.fadeAlpha})}},leftClick:function(){Ia.toggleFullscreen()}})}function je(){this.depth=-1e3,this.sprite=xi(Ze+"ui_window_controls.png"),this.radioSprite=xi(Ze+"ui_controls_selectiondot.png"),this.update=function(t){Ia.room.modal==this&&(mi(this.selectMouse,this.selectMouse.area),mi(this.selectKeyboard,this.selectKeyboard.area),mi(this.saveChanges,this.saveChanges.area))},this.draw=function(){Ia.room.modal==this&&(Si(this.sprite,{pos:{x:aa.width/2-this.sprite.width/2,y:aa.height/2-this.sprite.height/2}}),Si(this.radioSprite,{pos:{x:289,y:250+53*this.radio}}))},preOptions[3]?this.radio=!0:this.radio=!1,this.selectMouse={pos:ne(286,247),area:{width:25,height:25},leftClick:function(){Ia.controls.radio=!1},cursor:"pointer"},this.selectKeyboard={pos:ne(286,297),area:{width:25,height:25},leftClick:function(){Ia.controls.radio=!0},cursor:"pointer"},this.saveChanges={cursor:"pointer",pos:ne(276,378),area:{width:150,height:75},leftClick:function(){if(Ia.room.name&&"battleRoom"==Ia.room.name)socket.emit(Ke.saveOptions,[Ia.options.ticks[0].ticked,Ia.options.ticks[1].ticked,Ia.options.ticks[2].ticked,Ia.controls.radio]);else{var t="/content/battle/public_ajax.php?a=options&t0="+Ia.options.ticks[0].ticked+"&t1="+Ia.options.ticks[1].ticked+"&t2="+Ia.options.ticks[2].ticked+"&t3="+Ia.controls.radio;$.ajax({url:t,success:function(t){}})}Ia.room.modal=null}}}function We(t){if("string"==typeof t){for(var i in Oa)if(Oa[i].name==t)return Oa[i]}else for(var i in Oa)if(Oa[i].id==t)return Oa[i];return!1}function ze(t){var i=t.winType==ua.P2_WIN,e=t.winType==ua.P1_WIN,a=[];for(var n in t.loot)a.push(new ke(a.length,t.loot[n]));for(var s=[],n=0;n<t.xpBars.length;++n)s.push(new Me(n,t.xpBars[n],t.battleLevels));return{loot:a,exp:t.exp,hasAlerted:!1,victoryChain:t.victoryChain,xpBars:s,sprite:xi(Ze+"strip2_winScreen_rev2.png"),victoryChainSprite:xi("/content/battle/images/strip5_victoryChain.png"),alpha:0,fadeSpeed:2,mainMenuButton:{pos:ne(338,408),area:{width:147,height:88},update:function(t){mi(this,this.area)},cursor:"pointer",selected:!1,leftClick:function(){this.selected||(coliseumSelect("mainMenu"),this.selected=!0)}},fightOnButton:{pos:ne(494,408),area:{width:147,height:88},update:function(t){mi(this,this.area)},cursor:"pointer",selected:!1,leftClick:function(){this.selected||(socket.emit(Ke.fightOn),this.selected=!0)}},update:function(t){if(!Ia.room.currentAction&&(this.alpha+=t*this.fadeSpeed,this.alpha>1)){this.xpBarRoll+=t/1.5,this.xpBarRoll>1&&(this.xpBarRoll=1),this.mainMenuButton.update(t),this.fightOnButton.update(t);var i=null;for(var e in this.loot)if(this.loot[e].isMousedOver()){i=this.loot[e];break}for(e in this.xpBars)this.xpBars[e].update(t);i?Ia.tooltip.showTip(i.itemid,i.category,ne(113,167)):Ia.tooltip.hideTip(),Ia.conditionTooltip&&Ia.conditionTooltip.hide()}},draw:function(){if(!Ia.room.currentAction)if(e){Si(this.sprite,{frame:1,alpha:this.alpha});var t=Gi(this.victoryChain,0,4);Si(this.victoryChainSprite,{frame:t,pos:ne(66,420),alpha:this.alpha}),Bi({text:this.exp,pos:ne(367,115),bold:!0,size:16,family:"Verdana",halign:"right",valign:"bottom",color:"#c952dc",alpha:this.alpha,simpleShadow:!0,simpleShadowOffset:ne(1,1)});for(var a in this.loot)this.loot[a].draw(this.alpha);for(a in this.xpBars)this.xpBars[a].draw(this.alpha);for(a in this.xpBars)this.xpBars[a].drawToasts()}else i&&Si(this.sprite,{frame:0,alpha:this.alpha})}}}function Ye(){this.active=!1,this.depth=-1e3,this.activate=function(){Ia.room.modal||Ia.room.battleEnded||(this.active=!0)},this.deactivate=function(){this.active=!1,fa=!1},this.ticks=[new He(this,260,225),new He(this,260,269),new He(this,260,312)],this.saveButton={position:ne(276,377),sprite:new ye(276,377,426,451),leftClick:function(t){if(Ia.room.name&&"battleRoom"==Ia.room.name)socket.emit(Ke.saveOptions,[Ia.options.ticks[0].ticked,Ia.options.ticks[1].ticked,Ia.options.ticks[2].ticked,Ia.controls.radio]);else{var i="/content/battle/public_ajax.php?a=options&t0="+Ia.options.ticks[0].ticked+"&t1="+Ia.options.ticks[1].ticked+"&t2="+Ia.options.ticks[2].ticked+"&t3="+Ia.controls.radio;$.ajax({url:i,success:function(t){}})}Ia.options.deactivate()},active:!0,cursor:"pointer"},this.update=function(t){if(!this.active)return void(Ia.room.modal==this&&(Ia.room.modal=!1));if(Ia.room.battleEnded)return void(this.active=!1);Ia.room.modal=this;for(var i in this.ticks)mi(this.ticks[i]);mi(this.saveButton)},this.draw=function(){if(this.active){var t=xi(Ze+"menu_options.png"),i=xi(Ze+"icon_check.png");Si(t,{x:aa.width/2-t.width/2,y:aa.height/2-t.height/2});for(var e in this.ticks){var a=this.ticks[e];a.ticked&&Si(i,{x:a.position.x-5,y:a.position.y-5})}}};for(var t in this.ticks)preOptions[t]&&this.ticks[t].leftClick()}function He(t,i,e){this.obj=t,this.ticked=!1,this.sprite={width:200,height:26,frames:1},this.position=ne(i,e),this.leftClick=function(t){this.ticked?this.ticked=!1:this.ticked=!0,this.obj.weather=this.obj.ticks[0].ticked,this.obj.animations=this.obj.ticks[1].ticked,this.obj.flashes=this.obj.ticks[2].ticked},this.active=!0,this.cursor="pointer"}function Ue(t,i){if(!Pa[t]){Pa[t]=!0;var e={a:"client_error",type:t};coliBuildInfo&&coliBuildInfo.id&&(e.build=coliBuildInfo.id),i&&(e.error_message=i.toString(),i.stack&&(e.stack=i.stack.toString())),$.ajax("/content/battle/public_ajax.php",{method:"POST",data:e})}}function Ge(){function t(){socket.emit(Ke.ping,Ia.getTimestamp())}function i(t){s=t}function e(){Ue(Da.CONNECTION_FAILED),alert("Unable to connect to the game server. If the problem persists, please try toggling the Alternate Socket option in your Account Settings.")}function a(){l||(Ue(Da.DISCONNECT),alert("Connection to Flight Rising server lost. The server may be down, or unresponsive. Please check that your internet connection, noScript and antivirus software are properly configured, and not set to block flightrising.com."))}function n(){return Ia.room&&"battleRoom"==Ia.room.name}var s=Ta.CONNECTING;session=!1,socket=io.connect(socket_address,{reconnection:!1,timeout:15e3,path:socket_path});var r=null,o=3e3,h=-1,l=!1;socket.on("connect",function(t){s==Ta.CONNECTING&&i(Ta.WAIT_ACCEPT)}),socket.on("connect_error",function(t){s==Ta.CONNECTING&&(e(),i(Ta.CONNECTION_FAILED))}),socket.on("connect_timeout",function(t){s==Ta.CONNECTING&&(e(),i(Ta.CONNECTION_FAILED))}),socket.on("accept",function(e){function l(){return}function c(t){g.val(t),g[0].setSelectionRange(t.length,t.length)}if(s===Ta.WAIT_ACCEPT){i(Ta.CONNECTED),Ke={};for(var d=0;d<pa.length;++d)Ke[pa[d]]=e[d];socket.on(Ke.pong,function(i){var e=Ia.getTimestamp();h=Math.max(0,Math.round(e-i)),s!==Ta.DISCONNECTED&&(r=setTimeout(t,o))}),t(),socket.emit(Ke.authenticate,[socket_enc,session]),socket.on(Ke.session,function(t){se(t)}),socket.on(Ke.campShow,function(t){Ia.room=new Fe}),socket.on("disconnect",function(t){s!==Ta.DISCONNECTED&&(a(),i(Ta.DISCONNECTED)),null!==r&&clearTimeout(r)}),socket.on(Ke.console,function(t){var i=document.getElementById("devConsole");i.innerHTML=t,i.scrollTop=i.scrollHeight}),socket.on(Ke.serverMessage,function(t){switch(t){case"no_dragon":var i=new be("battleui/party_change.png");Ia.objects.add(i),Ia.room.modal=i;break;case"duplicate_login":alert("Duplicate login detected."),setTimeout(function(){coliseumSelect("mainMenu")},2e3)}}),socket.on(Ke.turnOrder,function(t){n()&&Ia.room.actionQueue.arr.push([992,t])}),socket.on(Ke.actionQueue,function(t){if(n())for(var i in t)Ia.room.actionQueue.arr.push(t[i])}),socket.on(Ke.endBattle,function(t){n()&&Ia.room.actionQueue.arr.push([990,t])}),socket.on(Ke.reveal,function(){ia=!0});var p=!0;socket.on(Ke.cprint,function(t){var i=$("#coli-console-history");p||i.append("<br>"),p=!1,i.append(document.createTextNode(t)),i.scrollTop(i[0].scrollHeight)}),socket.on(Ke.ctweak,function(t){t.length>=2&&"timescale"===t[0]&&(Ia.tweaks.timescale=t[1])});var u=[],f=-1,m="",g=$("#coli-console-prompt");$("#coli-console-prompt").keydown(function(t){if(13==t.which){t.preventDefault();var i=g.val();socket.emit(Ke.ccmd,i),""!==i&&(0===u.length||u[u.length-1]!==i)&&u.push(i),m="",f=-1,c(""),l()}else if(38==t.which){t.preventDefault();var i=g.val();0===f||(-1===f?u.length>0&&(m=i,f=u.length-1,c(u[f])):(f--,c(u[f]))),l()}else 40==t.which&&(t.preventDefault(),-1===f||(f===u.length-1?(c(m),f=-1):(f++,c(u[f]))),l())})}});var c=document.getElementById("consoleText");return $("#consoleText").keydown(function(t){13==t.which&&(socket.emit(Ke.admin,c.value),c.value="")}),window.onBeforeColiseumNavigate=function(){l=!0},Ia.connectionManager={getState:function(){return s},getSimpleState:function(){switch(s){case Ta.CONNECTING:case Ta.WAIT_ACCEPT:return Ba.CONNECTING;case Ta.CONNECTED:return Ba.CONNECTED;case Ta.DISCONNECTED:case Ta.CONNECTION_FAILED:default:return Ba.DISCONNECTED}},getPing:function(){return h},getTransportName:function(){try{if(socket.connected&&socket.io&&socket.io.engine&&socket.io.engine.transport)return socket.io.engine.transport.name}catch(t){}return"?"}},socket}function Ve(){this.tipDiv=document.getElementById("coli_tooltip"),this.cache={},this.sequence=0,this.desiredTipId=0,this.showTip=function(t,i,e){e||(e=ne()),this.tipDiv.style.left=e.x+"px",this.tipDiv.style.top=e.y+"px",this.desiredTipId!=t&&(this.tipDiv.style.visibility="hidden",this.desiredTipId=t,this._startTipLoad(t,i))},this.hideTip=function(){0!=this.desiredTipId&&(this.desiredTipId=0,this.tipID=0,this.tipDiv.style.visibility="hidden")},this._startTipLoad=function(t,i,e){if(void 0!==this.cache[t])this._showTipHTML(t);else{var a=this;$.ajax({url:"/includes/itemajax.php",data:{id:t,tab:i,clickable:0},success:function(i){a.cache[t]=i,a.desiredTipId==t&&a._showTipHTML(t)}})}},this._showTipHTML=function(t){this.tipID=t,this.tipDiv.style.visibility="visible",this.tipDiv.innerHTML="<div style='margin: 5px;'>"+this.cache[t]+"</div>"}}var $e=[],qe=[],Xe=[],Ke=[],Qe=[],Ze="/content/battle/images/",Je="/images/cms/abilities/",ia=!1,ea={x:0,y:0},aa=document.getElementById("cnv"),na=aa.getContext("2d"),sa=document.getElementById("drawingCanvas"),ra=sa.getContext("2d");na._xform=[1,0,0,1,0,0],na.getXform=function(){return this._xform.slice()},na.setXform=function(t){this._xform=t.slice(),this.setTransform.apply(this,t)},_mouse=ea;var oa={0:{affectedBySilence:!1,breathCost:0,id:0,name:"Defend",targeting:"SELF"},1:{affectedBySilence:!1,breathCost:-6,id:1,name:"Scratch",targeting:"ENEMY"},2:{affectedBySilence:!1,breathCost:-30,id:2,name:"Meditate",targeting:"SELF"},3:{affectedBySilence:!0,breathCost:10,id:3,name:"Shred",targeting:"ENEMY"},4:{affectedBySilence:!0,breathCost:35,id:4,name:"Eliminate",targeting:"ENEMY"},5:{affectedBySilence:!0,breathCost:20,id:5,name:"Mana Bolt",targeting:"ENEMY"},6:{affectedBySilence:!0,breathCost:20,id:6,name:"Boulder Bolt",targeting:"ENEMY"},7:{affectedBySilence:!0,breathCost:20,id:7,name:"Flame Bolt",targeting:"ENEMY"},8:{affectedBySilence:!0,breathCost:20,id:8,name:"Frigid Bolt",targeting:"ENEMY"},9:{affectedBySilence:!0,breathCost:20,id:9,name:"Bright Bolt",targeting:"ENEMY"},10:{affectedBySilence:!0,breathCost:20,id:10,name:"Shock Bolt",targeting:"ENEMY"},11:{affectedBySilence:!0,breathCost:20,id:11,name:"Vile Bolt",targeting:"ENEMY"},12:{affectedBySilence:!0,breathCost:20,id:12,name:"Dark Bolt",targeting:"ENEMY"},13:{affectedBySilence:!0,breathCost:20,id:13,name:"Hydro Bolt",targeting:"ENEMY"},14:{affectedBySilence:!0,breathCost:20,id:14,name:"Zephyr Bolt",targeting:"ENEMY"},15:{affectedBySilence:!0,breathCost:20,id:15,name:"Leaf Bolt",targeting:"ENEMY"},16:{affectedBySilence:!0,breathCost:16,id:16,name:"Rune Slash",targeting:"ENEMY"},17:{affectedBySilence:!0,breathCost:16,id:17,name:"Rock Slash",targeting:"ENEMY"},18:{affectedBySilence:!0,breathCost:16,id:18,name:"Blazing Slash",targeting:"ENEMY"},19:{affectedBySilence:!0,breathCost:16,id:19,name:"Freezing Slash",targeting:"ENEMY"},20:{affectedBySilence:!0,breathCost:16,id:20,name:"Blinding Slash",targeting:"ENEMY"},21:{affectedBySilence:!0,breathCost:16,id:21,name:"Thunder Slash",targeting:"ENEMY"},22:{affectedBySilence:!0,breathCost:16,id:22,name:"Jungle Slash",targeting:"ENEMY"},23:{affectedBySilence:!0,breathCost:16,id:23,name:"Pestilent Slash",targeting:"ENEMY"},24:{affectedBySilence:!0,breathCost:16,id:24,name:"Mist Slash",targeting:"ENEMY"},25:{affectedBySilence:!0,breathCost:16,id:25,name:"Wave Slash",targeting:"ENEMY"},26:{affectedBySilence:!0,breathCost:16,id:26,name:"Gust Slash",targeting:"ENEMY"},27:{affectedBySilence:!0,breathCost:-5,id:27,name:"Haste",targeting:"FRIENDLY"},28:{affectedBySilence:!0,breathCost:-5,id:28,name:"Concentration",targeting:"FRIENDLY"},29:{affectedBySilence:!0,breathCost:40,id:29,name:"Reflect",targeting:"ANY"},30:{affectedBySilence:!0,breathCost:-5,id:30,name:"Bolster",targeting:"FRIENDLY"},31:{affectedBySilence:!0,breathCost:-5,id:31,name:"Ward",targeting:"FRIENDLY"},32:{affectedBySilence:!0,breathCost:-5,id:32,name:"Rally",targeting:"FRIENDLY"},33:{affectedBySilence:!0,breathCost:40,id:33,name:"Regeneration",targeting:"FRIENDLY"},34:{affectedBySilence:!1,breathCost:0,id:34,name:"Potion Heal 100",targeting:"FRIENDLY"},35:{affectedBySilence:!0,breathCost:-4,id:35,name:"Anticipate",targeting:"SELF"},36:{affectedBySilence:!0,breathCost:18,id:36,name:"Contuse",targeting:"ENEMY"},37:{affectedBySilence:!0,breathCost:20,id:37,name:"Enfeeble",targeting:"ENEMY"},38:{affectedBySilence:!1,breathCost:0,id:38,name:"Flutter",targeting:"SELF"},39:{affectedBySilence:!0,breathCost:20,id:39,name:"Shroud",targeting:"ENEMY"},40:{affectedBySilence:!0,breathCost:20,id:40,name:"Sear",targeting:"ENEMY"},41:{affectedBySilence:!0,breathCost:20,id:41,name:"Contaminate",targeting:"ENEMY"},42:{affectedBySilence:!0,breathCost:20,id:42,name:"Fossilize",targeting:"ENEMY"},43:{affectedBySilence:!0,breathCost:20,id:43,name:"Congeal",targeting:"ENEMY"},45:{affectedBySilence:!0,breathCost:20,id:45,name:"Enamor",targeting:"ENEMY"},46:{affectedBySilence:!0,breathCost:20,id:46,name:"Shock",targeting:"ENEMY"},47:{affectedBySilence:!0,breathCost:20,id:47,name:"Envenom",targeting:"ENEMY"},48:{affectedBySilence:!0,breathCost:20,id:48,name:"Drown",targeting:"ENEMY"},49:{affectedBySilence:!0,breathCost:20,id:49,name:"Disorient",targeting:"ENEMY"},51:{affectedBySilence:!1,breathCost:-30,id:51,name:"Pollenate",targeting:"SELF"},52:{affectedBySilence:!0,breathCost:40,id:52,name:"Aid",targeting:"FRIENDLY"},53:{affectedBySilence:!0,breathCost:15,id:53,name:"Sap",targeting:"ENEMY"},54:{affectedBySilence:!0,breathCost:35,id:54,name:"Clobber",targeting:"ENEMY"},56:{affectedBySilence:!0,breathCost:0,id:56,name:"Guard",targeting:"FRIENDLY_NOT_SELF"},59:{affectedBySilence:!1,breathCost:0,id:59,name:"Potion Heal 250",targeting:"FRIENDLY"},60:{affectedBySilence:!1,breathCost:0,id:60,name:"Potion Heal 500",targeting:"FRIENDLY"},61:{affectedBySilence:!1,breathCost:0,id:61,name:"Elixir 1 Condition",targeting:"FRIENDLY"},62:{affectedBySilence:!1,breathCost:0,id:62,name:"Elixir All Conditions",targeting:"FRIENDLY"},63:{affectedBySilence:!1,breathCost:-6,id:63,name:"Bite",targeting:"ENEMY"},68:{affectedBySilence:!1,breathCost:-6,id:68,name:"Scratch - Irradiated",targeting:"ENEMY"},69:{affectedBySilence:!1,breathCost:-30,id:69,name:"Silverglow Meditate",targeting:"SELF"},70:{affectedBySilence:!0,breathCost:40,id:70,name:"Empathetic Regeneration",targeting:"FRIENDLY"},71:{affectedBySilence:!1,breathCost:-4,id:71,name:"Plumed Anticipate",targeting:"SELF"},72:{affectedBySilence:!1,breathCost:-30,id:72,name:"Prismatic Meditate",targeting:"SELF"},999:{affectedBySilence:!1,breathCost:0,id:999,name:"Nothing",targeting:"SELF"}},ha={};ha.DEFEND=0,ha.SCRATCH=1,ha.MEDITATE=2,ha.SHRED=3,ha.ELIMINATE=4,ha.MANA_BOLT=5,ha.BOULDER_BOLT=6,ha.FLAME_BOLT=7,ha.FRIGID_BOLT=8,ha.BRIGHT_BOLT=9,ha.SHOCK_BOLT=10,ha.VILE_BOLT=11,ha.DARK_BOLT=12,ha.HYDRO_BOLT=13,ha.ZEPHYR_BOLT=14,ha.LEAF_BOLT=15,ha.RUNE_SLASH=16,ha.ROCK_SLASH=17,ha.BLAZING_SLASH=18,ha.FREEZING_SLASH=19,ha.BLINDING_SLASH=20,ha.THUNDER_SLASH=21,ha.JUNGLE_SLASH=22,ha.PESTILENT_SLASH=23,ha.MIST_SLASH=24,ha.WAVE_SLASH=25,ha.GUST_SLASH=26,ha.HASTE=27,ha.CONCENTRATION=28,ha.REFLECT=29,ha.BOLSTER=30,ha.WARD=31,ha.RALLY=32,ha.REGENERATION=33,ha.POTION_HEAL_100=34,ha.ANTICIPATE=35,ha.CONTUSE=36,ha.ENFEEBLE=37,ha.FLUTTER=38,ha.SHROUD=39,ha.SEAR=40,ha.CONTAMINATE=41,ha.FOSSILIZE=42,ha.CONGEAL=43,ha.ENAMOR=45,ha.SHOCK=46,ha.ENVENOM=47,ha.DROWN=48,ha.DISORIENT=49,ha.POLLENATE=51,ha.AID=52,ha.SAP=53,ha.CLOBBER=54,ha.GUARD=56,ha.POTION_HEAL_250=59,ha.POTION_HEAL_500=60,ha.ELIXIR_1_CONDITION=61,ha.ELIXIR_ALL_CONDITIONS=62,ha.BITE=63,ha.SCRATCH_IRRADIATED=68,ha.SILVERGLOW_MEDITATE=69,ha.EMPATHETIC_REGENERATION=70,ha.PLUMED_ANTICIPATE=71,ha.PRISMATIC_MEDITATE=72,ha.NOTHING=999;var la={HIT:1,DODGE:0,CRIT:2,MISS:3},ca={STRONG:1,WEAK:-1,NORMAL:0},da={SELF:"SELF",ENEMY:"ENEMY",FRIENDLY:"FRIENDLY",FRIENDLY_NOT_SELF:"FRIENDLY_NOT_SELF",ANY:"ANY"},pa=["admin","authenticate","session","volume","console","serverMessage","turnOrder","useTurn","actionQueue","endBattle","saveOptions","reveal","ccmd","cprint","ctweak","ping","pong","fightOn","campShow","campDone"],ua={IN_PROGRESS:"IN_PROGRESS",P1_DISCONNECT:"P1_DISCONNECT",P2_DISCONNECT:"P2_DISCONNECT",P1_IDLE_OUT:"P1_IDLE_OUT",P2_IDLE_OUT:"P2_IDLE_OUT",P1_WIN:"P1_WIN",P2_WIN:"P2_WIN",P1_FLEE:"P1_FLEE",P2_FLEE:"P2_FLEE",P1_PARTY_CHANGED:"P1_PARTY_CHANGED",P2_PARTY_CHANGED:"P2_PARTY_CHANGED",P1_ENERGY_LOW:"P1_ENERGY_LOW",P2_ENERGY_LOW:"P2_ENERGY_LOW",P1_DUPLICATE:"P1_DUPLICATE",P2_DUPLICATE:"P2_DUPLICATE"};$e[0]=i,e(a,di),e(n,di),s.prototype.update=function(t){this.spritz=new me({heal:this.args.amount<0,amount:Math.abs(this.args.amount),target:this.args.target,critical:this.args.hitType,clash:this.args.clash})},s.prototype.isDone=function(){return null!==this.spritz},$e[1]=d,$e[2]=f,$e[3]=m,$e[4]=g,$e[5]=y,$e[6]=A,$e[7]=x,$e[8]=S,$e[9]=_,$e[10]=C,$e[11]=k,$e[12]=E,$e[13]=O,$e[14]=T,$e[15]=B,$e[16]=D,$e[17]=P,$e[18]=I,$e[19]=N,$e[20]=M,$e[21]=F,$e[22]=R,$e[23]=L,$e[24]=j,$e[25]=W,$e[26]=z,$e[27]=H,$e[28]=G,$e[29]=q,$e[30]=X,$e[31]=K,$e[32]=Q,$e[33]=J,$e[34]=it,$e[35]=nt,$e[36]=st,$e[37]=rt,$e[38]=ot,$e[39]=ht,$e[40]=lt,$e[41]=ct,$e[42]=dt,$e[43]=pt,$e[45]=ut,$e[46]=ft,$e[47]=mt,$e[48]=gt,$e[49]=wt,$e[51]=vt,$e[52]=yt,$e[53]=xt,$e[54]=St,$e[56]=_t,$e[59]=Ct,$e[60]=kt,$e[61]=Et,$e[62]=Ot,$e[63]=Tt,$e[68]=d,$e[69]=Bt,$e[70]=Dt,$e[71]=Pt,$e[72]=It,$e[989]=Nt,$e[990]=Mt,$e[991]=Ft,$e[992]=Rt,$e[993]=jt,$e[994]=Wt,$e[995]=Ht,$e[996]=Ut,$e[997]=Gt,$e[998]=Vt,$e[999]=$t,qe[1]=function(t){Xt.call(this,t,{})},qe[2]=function(t){Kt.call(this,t,{})},qe[3]=function(t){Xt.call(this,t,{})},qe[4]=function(t){Xt.call(this,t,{yOffset:-25})},qe[5]=function(t){Jt.call(this,t,{})},qe[6]=function(t){Jt.call(this,t,{})},qe[7]=function(t){Jt.call(this,t,{})},qe[8]=function(t){Jt.call(this,t,{})},qe[9]=function(t){Jt.call(this,t,{})},qe[10]=function(t){Jt.call(this,t,{})},qe[11]=function(t){Jt.call(this,t,{})},qe[12]=function(t){Jt.call(this,t,{})},qe[13]=function(t){Jt.call(this,t,{})},qe[14]=function(t){Jt.call(this,t,{})},qe[15]=function(t){Jt.call(this,t,{})},qe[16]=function(t){Xt.call(this,t,{});
},qe[17]=function(t){Xt.call(this,t,{})},qe[18]=function(t){Xt.call(this,t,{})},qe[19]=function(t){Xt.call(this,t,{})},qe[20]=function(t){Xt.call(this,t,{})},qe[21]=function(t){Xt.call(this,t,{})},qe[22]=function(t){Xt.call(this,t,{})},qe[23]=function(t){Xt.call(this,t,{})},qe[24]=function(t){Xt.call(this,t,{})},qe[25]=function(t){Xt.call(this,t,{})},qe[26]=function(t){Xt.call(this,t,{})},qe[27]=function(t){ti.call(this,t,{duration:1.7,blue:!0}),this.sprite=qt(this.abilityId,{frames:10});var i=this;this.addAfterDrawActor(function(t){if(t===i.target&&i.spriteAlpha>0){var e=i.sprite;Si(e,{pos:i.spriteDrawCenter,xOrigin:.5,yOrigin:.5,alpha:i.spriteAlpha})}})},qe[28]=function(t){ii.call(this,t,{blue:!0})},qe[29]=function(t){ei.call(this,t,{bubbleType:_a.REFLECT})},qe[30]=function(t){ei.call(this,t,{bubbleType:_a.BOLSTER})},qe[31]=function(t){ei.call(this,t,{bubbleType:_a.WARD})},qe[32]=function(t){ti.call(this,t,{duration:1.7,blue:!0}),this.sprite=qt(this.abilityId,{frames:2});var i=this,e=-30;this.addBeforeDrawActor(function(t){t==i.target&&i.spriteAlpha>0&&Si(i.sprite,{pos:ne(i.simpleTargetCenter.x,i.simpleTargetPos.y+e),alpha:i.spriteAlpha,frame:0,xOrigin:.5,yOrigin:0})}),this.addAfterDrawActor(function(t){t==i.target&&i.spriteAlpha>0&&Si(i.sprite,{pos:ne(i.simpleTargetCenter.x,i.simpleTargetPos.y+e),alpha:i.spriteAlpha,frame:1,xOrigin:.5,yOrigin:0})})},qe[33]=function(t){ai.call(this,t)},qe[34]=function(t){ni.call(this,t,{})},qe[35]=function(t){si.call(this,t,{})},qe[36]=function(t){Jt.call(this,t,{})},qe[37]=function(t){ii.call(this,t,{blue:!1})},qe[39]=function(t){ti.call(this,t,{duration:1.7,blue:!1}),this.sprite=xi("/content/battle/images/abilities/strip2_shroudA.png");var i=this;this.addAfterDrawActor(function(t){if(t===i.target&&i.spriteAlpha>0){var e=i.sprite;Si(e,{pos:i.spriteDrawCenter.add(-40,0),xOrigin:.5,yOrigin:.5,alpha:i.spriteAlpha,frame:0}),Si(e,{pos:i.spriteDrawCenter.add(40,0),xOrigin:.5,yOrigin:.5,alpha:i.spriteAlpha,frame:1})}})},qe[40]=function(t){ti.call(this,t,{duration:.9,blue:!1}),this.sprite=qt(this.abilityId,{frames:2});var i=this;this.addAfterDrawActor(function(t){if(t===i.target&&i.spriteAlpha>0){var e=i.sprite;i.target.playerControlled&&(e=Pi(e)),Si(e,{pos:i.spriteDrawCenter,xOrigin:.5,yOrigin:.5,alpha:i.spriteAlpha,frame:i.target.playerControlled?1:0})}})},qe[41]=function(t){ti.call(this,t,{duration:1.7,blue:!1}),this.sprite=qt(this.abilityId,{frames:3});var i=this;this.addAfterDrawActor(function(t){if(t===i.target&&i.spriteAlpha>0){var e=i.sprite;Si(e,{pos:i.spriteDrawCenter,xOrigin:.5,yOrigin:.5,alpha:i.spriteAlpha,frame:0}),Si(e,{pos:i.spriteDrawCenter.add(-60,0),xOrigin:.5,yOrigin:.5,alpha:i.spriteAlpha,frame:1}),Si(e,{pos:i.spriteDrawCenter.add(60,0),xOrigin:.5,yOrigin:.5,alpha:i.spriteAlpha,frame:2})}})},qe[42]=function(t){ti.call(this,t,{duration:1.8,blue:!1}),this.sprite=qt(this.abilityId,{frames:3});var i=this;this.addAfterDrawActor(function(t){if(t===i.target&&i.spriteAlpha>0){var e=i.sprite;Si(e,{pos:i.spriteDrawCenter,xOrigin:.5,yOrigin:.5,alpha:i.spriteAlpha,frame:0})}})},qe[43]=function(t){ti.call(this,t,{duration:1.7,blue:!1}),this.sprite=qt(this.abilityId,{frames:2});var i=this;this.addAfterDrawActor(function(t){if(t===i.target&&i.spriteAlpha>0){var e=i.sprite;Si(e,{pos:i.spriteDrawCenter,xOrigin:.5,yOrigin:.5,alpha:i.spriteAlpha,frame:1})}})},qe[45]=function(t){ti.call(this,t,{duration:1.3,blue:!1}),this.sprite=qt(this.abilityId,{frames:5});var i=this;this.addAfterDrawActor(function(t){if(t===i.target&&i.spriteAlpha>0){var e=i.sprite,a=e;i.target.playerControlled&&(a=Pi(e));var n;if(n=i.target.playerControlled?4:0,Si(a,{pos:i.spriteDrawCenter.add(0,-60),xOrigin:.5,yOrigin:.5,alpha:i.spriteAlpha,frame:n}),i.damage>0){var s=20;Si(e,{pos:i.spriteDrawCenter.add(s,-60),xOrigin:.5,yOrigin:.5,alpha:i.spriteAlpha,frame:4})}}})},qe[46]=function(t){ti.call(this,t,{duration:1.3,blue:!1}),this.sprite=qt(this.abilityId,{frames:3});var i=this;this.addAfterDrawActor(function(t){if(t===i.target&&i.spriteAlpha>0){var e=i.sprite;Si(e,{pos:i.spriteDrawCenter,xOrigin:.5,yOrigin:.5,alpha:i.spriteAlpha})}})},qe[47]=function(t){ti.call(this,t,{duration:1.5,blue:!1}),this.sprite=qt(this.abilityId,{frames:3});var i=this;this.addBeforeDrawActor(function(t){if(t===i.target&&i.spriteAlpha>0){var e=i.sprite;Si(e,{pos:i.spriteDrawCenter,xOrigin:.5,yOrigin:.5,alpha:i.spriteAlpha,frame:0})}}),this.addAfterDrawActor(function(t){if(t===i.target&&i.spriteAlpha>0){var e=i.sprite;Si(e,{pos:i.spriteDrawCenter.add(0,-30),xOrigin:.5,yOrigin:.5,alpha:i.spriteAlpha,frame:1}),Si(e,{pos:i.spriteDrawCenter.add(0,-30),xOrigin:.5,yOrigin:.5,alpha:i.spriteAlpha,frame:2})}})},qe[48]=function(t){ti.call(this,t,{duration:1.5,blue:!1}),this.sprite=qt(this.abilityId,{frames:3});var i=this;this.addAfterDrawActor(function(t){if(t===i.target&&i.spriteAlpha>0){var e=i.sprite;Si(e,{pos:i.spriteDrawCenter,xOrigin:.5,yOrigin:.5,alpha:i.spriteAlpha,frame:0})}})},qe[49]=function(t){ti.call(this,t,{duration:1.75,blue:!1}),this.sprite=qt(this.abilityId,{frames:4});var i=this;this.addAfterDrawActor(function(t){if(t===i.target&&i.spriteAlpha>0){var e=i.sprite;Si(e,{pos:i.spriteDrawCenter,xOrigin:.5,yOrigin:.5,alpha:i.spriteAlpha,frame:1})}})},qe[51]=function(t){Kt.call(this,t,{})},qe[52]=function(t){ti.call(this,t,{duration:1.2,blue:!1}),this.sprite=qt(this.abilityId,{frames:3});var i=this;this.addAfterDrawActor(function(t){if(t===i.target&&i.spriteAlpha>0){var e=i.sprite;Si(e,{pos:i.spriteDrawCenter,xOrigin:.5,yOrigin:.5,alpha:i.spriteAlpha,frame:0}),Si(e,{pos:i.spriteDrawCenter,xOrigin:.5,yOrigin:.5,alpha:i.spriteAlpha,frame:2})}})},qe[53]=function(t){h.call(this,t),this.sprite=qt(this.abilityId,{frames:4}),this.sparkleSprite=xi("/content/battle/images/abilities/strip2_sapsparkles.png"),this.spriteAlpha=0;var i=this;this.anims.add(new ri([new ci(function(){return i.sprite.loaded&&i.sparkleSprite.loaded}),new di({duration:.25,update:function(t){i.spriteAlpha=t}}),new di({duration:1.2,update:function(t){i.spriteAlpha=1}}),new di({duration:.25,update:function(t){i.spriteAlpha=1-t}}),new li(function(){i.fireSpritz()})])),this.addAfterDrawActor(function(t){if(t===i.target&&i.spriteAlpha>0){var e=i.sprite;i.target.playerControlled&&(e=Pi(e)),Si(e,{pos:i.simpleTargetCenter,xOrigin:.5,yOrigin:.5,frame:i.target.playerControlled?2:1,alpha:i.spriteAlpha}),i.damage>0&&(Si(i.sparkleSprite,{pos:i.simpleTargetCenter.add(0,-30),xOrigin:.5,yOrigin:.5,frame:0,alpha:i.spriteAlpha}),Si(i.sparkleSprite,{pos:i.simpleTargetCenter.add(0,-60),xOrigin:.5,yOrigin:.5,frame:1,alpha:i.spriteAlpha}))}})},qe[54]=function(t){h.call(this,t),this.sprite=qt(this.abilityId,{frames:1}),this.spriteAlpha=0;var i=this;this.anims.add(new ri([new ci(function(){return i.sprite.loaded}),new di({duration:.25,update:function(t){i.spriteAlpha=t}}),new di({duration:.8,update:function(t){i.spriteAlpha=1}}),new di({duration:.25,update:function(t){i.spriteAlpha=1-t}}),new li(function(){i.fireSpritz()})])),this.addAfterDrawActor(function(t){if(t===i.target&&i.spriteAlpha>0){var e=i.sprite,a=0;i.target.playerControlled?(e=Pi(e),a+=.5*i.target.sprite.frameWidth):a-=.5*i.target.sprite.frameWidth,Si(e,{pos:i.simpleTargetCenter.add(a,0),xOrigin:.5,yOrigin:.5,alpha:i.spriteAlpha})}})},qe[56]=function(t){si.call(this,t,{duration:1.8})},qe[59]=function(t){ni.call(this,t,{})},qe[60]=function(t){ni.call(this,t,{})},qe[61]=function(t){ni.call(this,t,{})},qe[62]=function(t){ni.call(this,t,{})},qe[63]=function(t){h.call(this,t),this.sprite=qt(this.abilityId,{frames:2}),this.spriteAlpha=0;var i=this;this.anims.add(new ri([new ci(function(){return i.sprite.loaded}),new di({duration:.25,update:function(t){i.spriteAlpha=t}}),new di({duration:1.2,update:function(t){i.spriteAlpha=1}}),new di({duration:.25,update:function(t){i.spriteAlpha=1-t}}),new li(function(){i.fireSpritz()})])),this.addAfterDrawActor(function(t){if(t===i.target&&i.spriteAlpha>0){var e=i.sprite;i.target.playerControlled&&(e=Pi(e)),Si(e,{pos:i.simpleTargetCenter,xOrigin:.5,yOrigin:.5,frame:i.target.playerControlled?1:0,alpha:i.spriteAlpha})}})},qe[68]=function(t){Xt.call(this,t,{})},qe[69]=function(t){Kt.call(this,t,{})},qe[70]=function(t){ai.call(this,t)},qe[71]=function(t){si.call(this,t,{})},qe[72]=function(t){Kt.call(this,t,{})},ri.prototype.update=function(t){if(this._pos<this._sequence.length){var i=this._sequence[this._pos];i.isDone()||i.update(t),i.isDone()&&this._pos++}},ri.prototype.add=function(t){this._sequence.push(t)},ri.prototype.isDone=function(){return this._pos>=this._sequence.length},oi.prototype.update=function(t){void 0===this._evalResult&&(this._condFunc()?this._evalResult=!0:this._evalResult=!1),this._evalResult&&ri.prototype.update.call(this,t)},oi.prototype.isDone=function(){return this._evalResult===!1||ri.prototype.isDone.call(this)},hi.prototype.add=function(t){this._anims.push(t)},hi.prototype.update=function(t){for(var i in this._anims)this._anims[i].isDone()||this._anims[i].update(t)},hi.prototype.isDone=function(){for(var t in this._anims)if(!this._anims[t].isDone())return!1;return!0},li.prototype.update=function(){this._fired||(this._func(),this._fired=!0)},li.prototype.isDone=function(){return this._fired},ci.prototype.update=function(){},ci.prototype.isDone=function(){return!this._done&&this._func()&&(this._done=!0),this._done},di.prototype.update=function(t){if(this._started||(this._start&&this._start(),this._started=!0),!this._finished)if(this._t+=t,this._t<this._duration){var i=0;this._duration>0&&(i=this._t/this._duration),this._updateFunc(i)}else this._updateFunc(1),this._finish&&this._finish(),this._finished=!0},di.prototype.isDone=function(){return this._finished},pi.prototype.update=function(t){if(!this._done){this._anim||(this._anim=this._animMaker());var i=this._anim.update(t);i&&(this._done=!0)}},pi.prototype.isDone=function(){return this._done},$("#cnv").bind("contextmenu",function(){return!1}),$("#cnv").mousedown(function(t){try{switch(t.which){case 3:t.preventDefault(),fa.rightClick&&fa.rightClick(t);break;case 2:break;default:var i=ui(t),e=Ia.mouseoverRects.findObjectAtPosition(i);e&&e.leftClick&&(t.preventDefault(),e.leftClick(t))}if(fa=!1)return!1}catch(a){throw Ue&&Ue(Da.EVENT_HANDLER_CRASH,a),a}}),$("#cnv").bind("touchstart",function(t){try{var i=t.originalEvent.changedTouches[0],e=fi(i),a=Ia.mouseoverRects.findObjectAtPosition(e);a&&!a.requireGesture&&a.leftClick&&(t.preventDefault(),a.leftClick(t),fa=!1)}catch(n){throw Ue&&Ue(Da.EVENT_HANDLER_CRASH,n),n}}),$(document).keydown(function(t){Ia.keyControls.push(t.which)}),$(window).mousemove(function(t){var i=ui(t);ea.x=i.x,ea.y=i.y,ea.pos=i});var fa=!1;Xe.push(function(){Ia.mouseoverRects=new gi,Ia.objects.add(Ia.mouseoverRects)});var ma=[],ga={px1:{position:ne(0,0),time:0,wave:ne(0,0),alpha:1,counter:0,visible:!0},px2:{position:ne(0,0),time:0,wave:ne(0,0),alpha:1,counter:0,visible:!0}},wa=700,va=361,ba={};_flipImage=Pi;var ya={intensity:1},Aa=[{x:521,y:431},{x:427,y:494},{x:490,y:494},{x:554,y:494},{x:620,y:494}],xa=65;new le(""),Xe.push(function(){Ia.conditionTooltip=new pe}),Xe.push(function(){fleeModal=new Ae}),_xx=0,_yy=0,Xe.push(function(){Ia.keyControls=new Ce,Ia.key_1=Ia.keyControls.keyBinds[49],Ia.key_2=Ia.keyControls.keyBinds[50],Ia.key_3=Ia.keyControls.keyBinds[51],Ia.key_4=Ia.keyControls.keyBinds[52],Ia.key_5=Ia.keyControls.keyBinds[53],Ia.key_6=Ia.keyControls.keyBinds[54],Ia.key_7=Ia.keyControls.keyBinds[55],Ia.key_q=Ia.keyControls.keyBinds[81],Ia.key_w=Ia.keyControls.keyBinds[87],Ia.key_e=Ia.keyControls.keyBinds[69],Ia.key_r=Ia.keyControls.keyBinds[82],Ia.key_t=Ia.keyControls.keyBinds[84],Ia.key_a=Ia.keyControls.keyBinds[65],Ia.key_s=Ia.keyControls.keyBinds[83],Ia.key_d=Ia.keyControls.keyBinds[68],Ia.key_f=Ia.keyControls.keyBinds[70],Ia.key_esc=Ia.keyControls.keyBinds[27],Ia.enemyBinds=[Ia.key_q,Ia.key_w,Ia.key_e,Ia.key_r],Ia.friendlyBinds=[Ia.key_a,Ia.key_s,Ia.key_d,Ia.key_f],Ia.consumableBinds=[Ia.key_q,Ia.key_w,Ia.key_e,Ia.key_r,Ia.key_t]}),Ee.prototype.drawOffscreen=function(t,i){var e=na;try{na=this.ctx,this.ctx.clearRect(0,0,this.width,this.height),t.call(i)}finally{na=e}};var Sa={UPDATE:"update",RENDER:"render",DEBUG:"debug"},_a={REFLECT:"REFLECT",BOLSTER:"BOLSTER",WARD:"WARD"},Ca=[_a.REFLECT,_a.BOLSTER,_a.WARD],ka={baseMovementSpeed:600,frameSpeed:7,jumpHeightModifier:.4,baseBubbleAlpha:.2,initBubbles:function(){var t={};for(var i in Ca)t[Ca[i]]={scale:0,alpha:0};return t[_a.REFLECT].sprite=xi(Je+"29.png"),t[_a.BOLSTER].sprite=xi(Je+"30.png"),t[_a.WARD].sprite=xi(Je+"31.png"),t},snapTo:function(t){this.position=t.copy()},update:function(t){if(Ia.options.animations&&(this.frame+=this.frameSpeed*t),this.alive||(this.alpha=ee(this.alpha-t)),!Ia.room.modal&&this.alive&&(mi(this),fa==this?this.selectionShadow=this.selectionShadowColor:this.selectionShadow=!1),this.floating&&Ia.options.animations){var i=10,e=20,a=10*Math.random()+7;this.floatDir?this.elevation>i?this.elevation-=t/2*a:this.elevation<=i&&(this.floatDir=0,this.floatSpeed=10*Math.random()+7):this.elevation<e?this.elevation+=t*a:this.elevation>=e&&(this.floatDir=1,this.floatSpeed=10*Math.random()+7)}this.playerControlled||this.unitFrame.update(t)},draw:function(){var t=this.position.add(ne(0,-this.elevation-this.additionalElevation));if(Ia.options.animations||(t=this.origin),this.alive||(this.elevation=0,this.playerControlled&&Si(this.defeatSprite,{pos:t,shadow:i,alpha:1-ee(this.alpha)})),!(this.alpha<=0)){var i=!1;this.selectionShadow&&fa==this&&Ia.room.actionPanel.validTargets.indexOf(this)>-1&&(i={color:this.selectionShadow,blur:4}),Si(this.sprite,{frame:this.frame||0,pos:t.add(.5*this.sprite.frameWidth,.5*this.sprite.height),shadow:i,alpha:this.alpha*this.alphaMultiplier,xOrigin:.5,yOrigin:.5,xScale:this.scale.x,yScale:this.scale.y}),this.keyBind&&this.keyBind.draw(this.position.x-(1-this.playerControlled)*this.keyBind.sprite.frameWidth+this.playerControlled*this.sprite.frameWidth,this.position.y+this.sprite.height/2-this.keyBind.sprite.height/2)}},drawShadow:function(){var t=this.sprite,i=this.elevation,e=this.position.x,a=this.position.y;Ia.options.animations||(i=0,e=this.origin.x,a=this.origin.y),ji(0,0,0,.5);var n=1.1*t.frameWidth-i/8,s=t.height/2.5,r=t.frameWidth,o=t.height,h=na.globalAlpha;this.playerControlled?na.globalAlpha=.5:na.globalAlpha=.5*this.alpha,bi(e-(n-r)/2,a+o-40,n,s),na.globalAlpha=h},drawBubbles:function(){if(this.alive)for(var t in Ca){var i=Ca[t],e=this.bubbles[i];if(e.alpha>0&&e.scale>0){var a=ne(this.sprite.frameWidth,this.sprite.height);Si(e.sprite,{pos:this.position.add(a.mul(.5)),alpha:e.alpha,xScale:e.scale,yScale:e.scale,flip:!this.playerControlled,xOrigin:.5,yOrigin:.5})}}},modHealth:function(t){this.alive&&(this.health.current+=t,this.health.current<1&&(this.health.current=0,this.die()),this.health.current>this.health.max&&(this.health.current=this.health.max))},modBreath:function(t){this.alive&&(this.breath.current+=t,this.breath.current<1&&(this.breath.current=0),this.breath.current>this.breath.max&&(this.breath.current=this.breath.max))},die:function(){this.alive=!1},isSilenced:function(){for(var t=0;t<this.conditions.length;++t)if("ico_silence"==this.conditions[t].iconName)return!0;return!1}},Ea={name:"nullRoom",update:function(t){},draw:function(){},modal:!1};Xe.push(function(){Ia.room=Ea}),Xe.push(function(){Ge()}),Xe.push(function(){Ia.controlPanel=new Le,Ia.objects.add(Ia.controlPanel)}),Xe.push(function(){Ia.controls=new je});var Oa={};Oa.normal={id:0,name:"Normal",color:"rgb(203, 203, 203)"},Oa.earth={id:1,name:"Earth",color:"rgb(186, 174, 153)"},Oa.plague={id:2,name:"Plague",color:"rgb(225, 157, 152)"},Oa.wind={id:3,name:"Wind",color:"rgb(209, 236, 173)"},Oa.water={id:4,name:"Water",color:"rgb(171, 191, 221)"},Oa.lightning={id:5,name:"Lightning",color:"rgb(192, 240, 241)"},Oa.ice={id:6,name:"Ice",color:"rgb(203, 230, 255)"},Oa.shadow={id:7,name:"Shadow",color:"rgb(163, 151, 180)"},Oa.light={id:8,name:"Light",color:"rgb(255, 249, 198)"},Oa.arcane={id:9,name:"Arcane",color:"rgb(249, 207, 248)"},Oa.nature={id:10,name:"Nature",color:"rgb(135, 195, 146)"},Oa.fire={id:11,name:"Fire",color:"rgb(238, 181, 125)"},Xe.push(function(){Ia.options=new Ye});var Ta={CONNECTING:"CONNECTING",CONNECTION_FAILED:"CONNECTION_FAILED",WAIT_ACCEPT:"WAIT_ACCEPT",CONNECTED:"CONNECTED",DISCONNECTED:"DISCONNECTED"},Ba={CONNECTING:"CONNECTING",CONNECTED:"CONNECTED",DISCONNECTED:"DISCONNECTED"},Da={DISCONNECT:"disconnect",CONNECTION_FAILED:"connection_failed",DESYNC:"desync",MAIN_LOOP_CRASH:"main_loop_crash",EVENT_HANDLER_CRASH:"event_handler_crash"},Pa={};Xe.push(function(){Ia.tooltip=new Ve}),ea.pos=ne();var Ia=new xe;_game=Ia;for(var Na in Xe)Xe[Na]();Ia.run()}();
//# sourceMappingURL=./tmp/battle_client.js.map